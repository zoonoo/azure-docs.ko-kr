---
title: 쿼리 모니터링
titleSuffix: Azure Cognitive Search
description: 성능 및 처리량에 대 한 쿼리 메트릭을 모니터링 합니다. 리소스 로그에서 쿼리 문자열 입력을 수집 하 고 분석 합니다.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/18/2020
ms.openlocfilehash: da7a47bf61453c30f5c735b1282ae93d2442598c
ms.sourcegitcommit: edccc241bc40b8b08f009baf29a5580bf53e220c
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/24/2020
ms.locfileid: "82127687"
---
# <a name="monitor-query-requests-in-azure-cognitive-search"></a>Azure Cognitive Search에서 쿼리 요청 모니터링

이 문서에서는 메트릭 및 리소스 로깅을 사용 하 여 쿼리 성능 및 볼륨을 측정 하는 방법을 설명 합니다. 또한 검색 모음의 유틸리티 및 효율성을 평가 해야 하는 경우 쿼리 관련 정보에 사용 되는 입력 용어를 수집 하는 방법을 설명 합니다.

메트릭에 대 한 기록 데이터는 30 일 동안 보존 됩니다. 더 긴 보존을 위해 또는 운영 데이터 및 쿼리 문자열을 보고 하려면 기록 된 이벤트 및 메트릭을 유지 하기 위한 저장소 옵션을 지정 하는 [진단 설정을](search-monitor-logs.md) 사용 하도록 설정 해야 합니다.

데이터 측정의 무결성을 최대화 하는 조건은 다음과 같습니다.

+ 청구 가능 서비스 (기본 또는 표준 계층에서 만든 서비스)를 사용 합니다. 무료 서비스는 여러 구독자가 공유 하므로 특정 양의 변동성을 로드 하는 것으로 제공 됩니다.

+ 가능 하면 단일 복제본 및 파티션을 사용 하 여 포함 된 격리 된 환경을 만듭니다. 여러 복제본을 사용 하는 경우 쿼리 메트릭은 여러 노드에 걸쳐 평균을 계산 하 여 결과의 전체 자릿수를 낮출 수 있습니다. 마찬가지로, 여러 파티션은 데이터가 분할 되는 것을 의미 하며, 인덱싱이 진행 중인 경우 일부 파티션에는 데이터가 다를 수 있습니다. 쿼리 성능을 조정할 때 단일 노드와 파티션은 더 안정적인 테스트 환경을 제공 합니다.

> [!Tip]
> 추가 클라이언트 쪽 코드와 Application Insights를 사용 하 여 클릭 광고 데이터를 캡처하여 응용 프로그램 사용자의 관심을 attracts에 대 한 심층적인 통찰력을 얻을 수도 있습니다. 자세한 내용은 [트래픽 분석 검색](search-traffic-analytics.md)을 참조하세요.

## <a name="query-volume-qps"></a>쿼리 볼륨 (QPS)

볼륨은 1 분 기간 내에 실행 되는 쿼리의 평균, 개수, 최소값 또는 최대값으로 보고할 수 있는 기본 제공 메트릭으로 **초당 검색 쿼리** (QPS)로 측정 됩니다. 메트릭에 대 한 1 분 간격 (TimeGrain = "PT1M")은 시스템 내에서 수정 됩니다.

쿼리가 실행 되는 데 일반적으로 밀리초 단위로 계산 되므로 시간 (초)으로 측정 되는 쿼리만 메트릭에 표시 됩니다.

| 집계 형식 | 설명 |
|------------------|-------------|
| 평균 | 쿼리가 실행 된 후 1 분 내에 발생 한 평균 시간 (초)입니다.|
| 개수 | 1 분 간격 내에 로그에 내보내는 메트릭 수입니다. |
| 최대 | 1 분 동안 등록 된 초당 최대 검색 쿼리 수입니다. |
| 최소 | 1 분 동안 등록 된 초당 검색 쿼리 수입니다.  |
| 합계 | 1 분 이내에 실행 된 모든 쿼리의 합계입니다.  |

예를 들어 1 분 이내에 SearchQueriesPerSecond에 대 한 최대값 인 높은 부하의 1 초, 평균 부하의 58 초, 마지막으로 하나의 쿼리 (최소 1 초)가 있는 것과 같은 패턴이 있을 수 있습니다.

또 다른 예: 노드가 100 메트릭을 내보내는 경우 (각 메트릭의 값이 40 인 경우 "Count"는 100, "Sum"은 4000, "Average"는 40, "Max"는 40입니다.

## <a name="query-performance"></a>쿼리 성능

서비스 전체의 쿼리 성능은 검색 대기 시간 (쿼리가 완료 되는 데 걸리는 시간) 및 제한 된 쿼리 (리소스 경합의 결과로 삭제 된 쿼리)로 측정 됩니다.

### <a name="search-latency"></a>검색 대기 시간

| 집계 형식 | 대기 시간 | 
|------------------|---------|
| 평균 | 평균 쿼리 기간 (밀리초)입니다. | 
| 개수 | 1 분 간격 내에 로그에 내보내는 메트릭 수입니다. |
| 최대 | 샘플에서 가장 오래 실행 되는 쿼리입니다. | 
| 최소 | 샘플에서 가장 짧은 실행 쿼리입니다.  | 
| 합계 | 이 샘플에 있는 모든 쿼리의 총 실행 시간 (1 분) 내에 실행 됩니다.  |

**검색 대기 시간** 메트릭에 대 한 다음 예제를 고려 합니다. 86 쿼리는 평균 기간이 23.26 밀리초로 샘플링 되었습니다. 최소 0은 일부 쿼리를 삭제 했음을 나타냅니다. 가장 오래 실행 되는 쿼리를 완료 하는 데 1000 밀리초가 걸렸습니다. 총 실행 시간은 2 초입니다.

![대기 시간 집계](./media/search-monitor-usage/metrics-latency.png "대기 시간 집계")

### <a name="throttled-queries"></a>제한 된 쿼리

제한 된 쿼리는 프로세스 대신 삭제 된 쿼리를 의미 합니다. 대부분의 경우 서비스를 실행 하는 것이 일반적으로 제한 됩니다.  문제가 있음을 나타내는 것은 아닙니다.

현재 처리 중인 요청 수가 사용 가능한 리소스를 초과 하는 경우 제한이 발생 합니다. 복제본이 순환 되지 않거나 인덱싱을 수행 하는 동안 제한 된 요청이 증가 하는 것을 볼 수 있습니다. 쿼리 및 인덱싱 요청은 모두 동일한 리소스 집합에서 처리 됩니다.

서비스는 리소스 소비량에 따라 요청을 삭제할지 여부를 결정 합니다. 메모리, CPU 및 디스크 IO에서 사용 되는 리소스의 비율은 일정 시간에 걸쳐 평균입니다. 이 백분율이 임계값을 초과 하는 경우 요청 볼륨이 감소할 때까지 인덱스에 대 한 모든 요청이 제한 됩니다. 

클라이언트에 따라 다음과 같은 방법으로 제한 된 요청을 나타낼 수 있습니다.

+ 서비스에서 "너무 많은 요청을 보내는 중입니다. 나중에 다시 시도하십시오." 
+ 서비스는 서비스를 현재 사용할 수 없음을 나타내는 503 오류 코드를 반환 합니다. 
+ 포털을 사용 하는 경우 (예: 검색 탐색기) 쿼리를 자동으로 삭제 하 고 검색을 다시 클릭 해야 합니다.

제한 된 쿼리를 확인 하려면 **제한 된 검색 쿼리** 메트릭을 사용 합니다. 포털에서 메트릭을 탐색 하거나이 문서에 설명 된 대로 경고 메트릭을 만들 수 있습니다. 샘플링 간격 내에 삭제 된 쿼리의 경우 *합계* 를 사용 하 여 실행 되지 않은 쿼리의 비율을 가져옵니다.

| 집계 형식 | 제한 |
|------------------|-----------|
| 평균 | 간격 내에 삭제 된 쿼리의 비율입니다. |
| 개수 | 1 분 간격 내에 로그에 내보내는 메트릭 수입니다. |
| 최대 | 간격 내에 삭제 된 쿼리의 비율입니다.|
| 최소 | 간격 내에 삭제 된 쿼리의 비율입니다. |
| 합계 | 간격 내에 삭제 된 쿼리의 비율입니다. |

**제한 된 검색 쿼리 백분율**, 최소, 최대, 평균 및 합계의 경우 1 분 동안 검색 쿼리의 총 수에서 제한 된 검색 쿼리의 비율입니다.

다음 스크린샷에서 첫 번째 숫자는 로그로 전송 되는 수 또는 메트릭 수입니다. 위쪽 또는 메트릭을 마우스로 가리킬 때 표시 되는 추가 집계는 평균, 최대값 및 합계를 포함 합니다. 이 샘플에서는 요청을 삭제 하지 않았습니다.

![제한 된 집계](./media/search-monitor-usage/metrics-throttle.png "제한 된 집계")

## <a name="explore-metrics-in-the-portal"></a>포털에서 메트릭 탐색

현재 수치를 빠르게 확인 하기 위해 서비스 개요 페이지의 **모니터링** 탭에는 집계 유형을 변경 하는 옵션을 사용 하 여 시간, 일 및 주 단위로 측정 되는 고정 된 간격에 대 한 세 가지 메트릭 (검색**대기 시간**, 검색 **쿼리 수/초 (검색 단위 당)** 검색 **쿼리 백분율**)이 표시 됩니다.

더 심층적으로 탐색 하려면 데이터를 계층화 하 고 확대 하 고 시각화 하 여 추세 또는 비정상을 탐색할 수 있도록 **모니터링** 메뉴에서 메트릭 탐색기를 엽니다. 메트릭 [차트 만들기에 대](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-metrics-explorer)한이 자습서를 완료 하 여 메트릭 탐색기에 대해 자세히 알아보세요.

1. 모니터링 섹션에서 **메트릭** 을 선택 하 여 검색 서비스에 설정 된 범위에서 메트릭 탐색기를 엽니다.

1. 메트릭 아래의 드롭다운 목록에서 하나를 선택 하 고 기본 유형에 사용 가능한 집계 목록을 검토 합니다. 집계는 각 시간 간격 동안 수집 된 값이 샘플링 되는 방법을 정의 합니다.

   ![QPS 메트릭에 대 한 메트릭 탐색기](./media/search-monitor-usage/metrics-explorer-qps.png "QPS 메트릭에 대 한 메트릭 탐색기")

1. 오른쪽 위 모서리에서 시간 간격을 설정 합니다.

1. 시각화를 선택 합니다. 기본값은 꺾은선형 차트입니다.

1. **메트릭 추가** 를 선택 하 고 다른 집계를 선택 하 여 추가 집계를 계층화 합니다.

1. 꺾은선형 차트에서 관심 영역을 확대 합니다. 영역의 시작 부분에 마우스 포인터를 놓고 마우스 왼쪽 단추를 누른 채 영역의 반대쪽으로 끈 후 단추를 놓습니다. 그러면 해당 시간 범위에서 차트가 확대됩니다.

## <a name="identify-strings-used-in-queries"></a>쿼리에서 사용 되는 문자열 식별

리소스 로깅을 사용 하도록 설정 하면 시스템은 **Azurediagnostics** 테이블에서 쿼리 요청을 캡처합니다. 필수 구성 요소로, log analytics 작업 영역 또는 다른 저장소 옵션을 지정 하 여 [리소스 로깅을](search-monitor-logs.md)이미 사용 하도록 설정 해야 합니다.

1. 모니터링 섹션에서 **로그** 를 선택 하 여 Log Analytics에서 빈 쿼리 창을 엽니다.

1. 다음 식을 실행 하 여 쿼리를 검색 하 고 작업 이름, 쿼리 문자열, 쿼리 된 인덱스 및 찾은 문서 수로 구성 된 테이블 형식 결과 집합을 반환 합니다. 마지막 두 문은 샘플 인덱스에 대해 비어 있거나 지정 되지 않은 검색으로 구성 된 쿼리 문자열을 제외 하며,이는 결과의 노이즈를 잘라냅니다.

   ```
   AzureDiagnostics
   | project OperationName, Query_s, IndexName_s, Documents_d
   | where OperationName == "Query.Search"
   | where Query_s != "?api-version=2019-05-06&search=*"
   | where IndexName_s != "realestate-us-sample-index"
   ```

1. 필요에 따라 특정 구문이 나 문자열을 검색 하도록 *Query_s* 열 필터를 설정 합니다. 예를 *들어를 필터링* `?api-version=2019-05-06&search=*&%24filter=HotelName`할 수 있습니다.

   ![기록 쿼리 문자열](./media/search-monitor-usage/log-query-strings.png "기록 쿼리 문자열")

이 기법은 임시 조사를 수행 하는 동안에는 보고서를 작성 하 여 분석에 더 취약 레이아웃으로 쿼리 문자열을 통합 하 고 표시할 수 있습니다.

## <a name="identify-long-running-queries"></a>장기 실행 쿼리 확인

기간 열을 추가 하 여 메트릭으로 선택 된 쿼리 뿐만 아니라 모든 쿼리에 대 한 숫자를 가져옵니다. 이 데이터를 정렬 하면 완료 하는 데 가장 오래 걸리는 쿼리를 볼 수 있습니다.

1. 모니터링 섹션 **에서 로그를 선택 하** 여 로그 정보를 쿼리 합니다.

1. 다음 쿼리를 실행 하 여 기간 (밀리초)을 기준으로 쿼리를 반환 합니다. 가장 오래 실행 되는 쿼리는 맨 위에 있습니다.

   ```
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search"
   | sort by DurationMs
   ```

   ![시간별 쿼리 정렬](./media/search-monitor-usage/azurediagnostics-table-sortby-duration.png "시간별 쿼리 정렬")

## <a name="create-a-metric-alert"></a>메트릭 경고 만들기

메트릭 경고는 알림을 받거나 미리 정의한 정정 작업을 트리거하는 임계값을 설정 합니다. 

검색 서비스의 경우 검색 대기 시간 및 제한 된 쿼리에 대 한 메트릭 경고를 만드는 것이 일반적입니다. 쿼리가 삭제 되는 시기를 알고 있으면 부하를 줄이거나 용량을 늘리는 해결책을 찾을 수 있습니다. 예를 들어 인덱싱 중에 제한 된 쿼리가 증가 하는 경우 쿼리 작업 하위 측까지 연기할 수 있습니다.

특정 복제본 파티션 구성의 제한을 푸시할 때 쿼리 볼륨 임계값 (QPS)에 대 한 경고를 설정 하는 것도 유용 합니다.

1. 모니터링 섹션에서 **경고** 를 선택 하 고 **+ 새 경고 규칙**을 클릭 합니다. 검색 서비스가 리소스로 선택 되어 있는지 확인 합니다.

1. 조건 아래에서 **추가**를 클릭 합니다.

1. 신호 논리를 구성 합니다. 신호 유형에서 **메트릭** 을 선택 하 고 신호를 선택 합니다.

1. 신호를 선택한 후에는 조건을 설정 하는 방법에 대 한 의사 결정을 위해 차트를 사용 하 여 기록 데이터를 시각화할 수 있습니다.

1. 다음으로, 경고 논리로 스크롤합니다. 개념 증명의 경우 테스트를 위해 인위적으로 낮은 값을 지정할 수 있습니다.

   ![경고 논리](./media/search-monitor-usage/alert-logic-qps.png "경고 논리")

1. 다음으로 작업 그룹을 지정 하거나 만듭니다. 임계값이 충족 될 때 호출할 응답입니다. 푸시 알림 또는 자동화 된 응답이 될 수 있습니다.

1. 마지막으로, 경고 세부 정보를 지정 합니다. 경고의 이름을 지정 하 고 설명 하 고, 심각도 값을 할당 하 고, 규칙을 사용 또는 사용 안 함 상태로 만들지 여부를 지정 합니다.

   ![경고 세부 정보](./media/search-monitor-usage/alert-details.png "경고 세부 정보")

전자 메일 알림을 지정한 경우 "Azure: 활성화 된 심각도: 3 `<your rule name>`"의 제목 줄이 포함 된 "Microsoft Azure"에서 전자 메일을 받게 됩니다.

<!-- ## Report query data

Power BI is an analytical reporting tool useful for visualizing data, including log information. If you are collecting data in Blob storage, a Power BI template makes it easy to spot anomalies or trends. Use this link to download the template. -->

## <a name="next-steps"></a>다음 단계

아직 수행 하지 않은 경우 검색 서비스 모니터링의 기본 사항을 검토 하 여 모든 감독 기능에 대해 알아보세요.

> [!div class="nextstepaction"]
> [Azure Cognitive Search에서 작업 및 작업 모니터링](search-monitor-usage.md)