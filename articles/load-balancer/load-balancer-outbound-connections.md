---
title: Azure에서 아웃바운드 연결
titlesuffix: Azure Load Balancer
description: 이 문서에서는 Azure에서 VM이 공용 인터넷 서비스를 사용하여 통신하는 방법을 설명합니다.
services: load-balancer
documentationcenter: na
author: KumudD
ms.service: load-balancer
ms.custom: seodec18
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/05/2019
ms.author: kumud
ms.openlocfilehash: a42a56b8a4a54c33297461a427a2b64b72357020
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/23/2019
ms.locfileid: "60591454"
---
# <a name="outbound-connections-in-azure"></a>Azure에서 아웃바운드 연결

Azure는 여러 메커니즘을 통해 고객 배포에 대한 아웃바운드 연결을 제공합니다. 이 문서에서는 시나리오, 적용 시기, 작동 방식 및 관리 방법을 설명합니다.

>[!NOTE] 
>이 문서에서는 리소스 관리자 배포에 대해서만 설명합니다. Azure의 모든 클래식 배포 시나리오는 [아웃 바운드 연결(클래식)](load-balancer-outbound-connections-classic.md)을 참조하세요.

Azure에 배포되는 솔루션은 공용 IP 주소 공간에 있는 Azure 외부의 엔드포인트와 통신할 수 있습니다. 인스턴스가 공용 IP 주소 공간에서 대상에 대한 아웃바운드 흐름을 시작하면 Azure는 개인 IP 주소를 공용 IP 주소에 동적으로 매핑합니다. 이 매핑이 생성되면 이 아웃바운드에서 시작된 흐름에 대한 반환 트래픽도 흐름이 시작된 개인 IP 주소에 연결할 수 있습니다.

Azure에서는 SNAT(원본 네트워크 주소 변환)를 사용하여 이 기능을 수행합니다. 단일 공용 IP 주소 뒤에서 여러 개인 IP 주소가 가장하는 경우 Azure는 [PAT(포트 주소 변환)](#pat)를 사용하여 개인 IP 주소를 가장합니다. 삭제 포트는 PAT에 사용되고 풀 크기에 따라 [미리 할당](#preallocatedports)됩니다.

여러 개의 [아웃바운드 시나리오](#scenarios)가 있습니다. 필요에 따라 이러한 시나리오를 결합할 수 있습니다. 주의 깊게 살펴보고 배포 모델 및 애플리케이션 시나리오에 적용되는 기능, 제약 조건 및 패턴을 이해합니다. [시나리오 관리](#snatexhaust) 지침을 검토합니다.

>[!IMPORTANT] 
>표준 Load Balancer 및 표준 공용 IP는 아웃바웃드 연결에 새로운 기능 및 서로 다른 동작을 도입합니다.  이는 기본 SKU와 동일하지 않습니다.  표준 SKU로 작업하는 경우 아웃바운드 연결을 하려는 경우 표준 공용 IP 주소 또는 표준 공용 Load Balancer를 사용하여 명시적으로 정의해야 합니다.  여기에는 내부 표준 Load Balancer를 사용할 경우 아웃바운드 연결 만들기가 포함됩니다.  표준 공용 Load Balancer에서 항상 아웃바운드 규칙을 사용하는 것이 좋습니다.  [시나리오 3](#defaultsnat)은 표준 SKU에서 사용할 수 없습니다.  즉, 내부 표준 Load Balancer를 사용하는 경우 아웃바운드 연결을 원하면 백 엔드 풀의 VM에 대한 아웃바운드 연결을 만드는 단계를 수행해야 합니다.  아웃바운드 연결, 단일 독립 실행형 VM, 가용성 세트의 모든 VM의 컨텍스트에서 VMSS의 모든 인스턴스는 그룹으로 작동합니다. 즉, 가용성 세트의 단일 VM을 표준 SKU와 연결하면 개별 인스턴스가 직접 표준 SKU와 연결되지 않더라도 해당 가용성 세트 내의 모든 VM 인스턴스는 이제 표준 SKU에 연결된 것처럼 동일한 규칙에 따라 작동합니다.  전반적인 개념을 이해하고 SKU 간 차이점에 대해 [표준 Load Balancer](load-balancer-standard-overview.md)를 검토하고 [아웃바운드 규칙](load-balancer-outbound-rules-overview.md)을 검토하려면 이 전체 문서를 검토합니다.  아웃바운드 규칙을 사용하면 아웃바운드 연결의 모든 측면에 대해 정밀하게 제어할 수 있습니다.

## <a name="scenarios"></a>시나리오 개요

[Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview)를 사용하는 경우 Azure Load Balancer 및 관련 리소스가 명시적으로 정의됩니다.  현재 Azure는 Azure Resource Manager 리소스에 대한 아웃바운드 연결을 달성할 수 있는 세 가지 방법을 제공합니다. 

| SKU | 시나리오 | 방법 | IP 프로토콜 | 설명 |
| --- | --- | --- | --- | --- |
| 표준, 기본 | [1. 인스턴스 수준 공용 IP 주소를 가진 VM(Load Balancer 있음 또는 없음)](#ilpip) | SNAT, 포트 가장 사용 안 함 | TCP, UDP, ICMP, ESP | Azure는 인스턴스 NIC의 IP 구성에 할당된 공용 IP를 사용합니다. 인스턴스에 있는 모든 삭제 포트를 사용할 수 있습니다. 표준 Load Balancer를 사용하는 경우 아웃바운드 연결을 명시적으로 정의하려면 [아웃바운드 규칙](load-balancer-outbound-rules-overview.md)을 사용해야 합니다. |
| 표준, 기본 | [2. VM과 연결된 공용 Load Balancer(인스턴스에 인스턴스 수준 공용 IP 주소 없음)](#lb) | Load Balancer 프런트 엔드를 사용하여 포트를 가장하는(PAT) SNAT | TCP, UDP |Azure는 공용 Load Balancer 프런트 엔드의 공용 IP 주소를 여러 개인 IP 주소와 공유합니다. Azure는 프런트 엔드의 삭제 포트를 PAT에 사용합니다. |
| 없음 또는 기본 | [3. 독립 실행형 VM(Load Balancer 없음, 인스턴스 수준 공용 IP 주소 없음)](#defaultsnat) | 포트를 가장하는(PAT) SNAT | TCP, UDP | Azure는 자동으로 SNAT에 대한 공용 IP 주소를 지정하고, 이 공용 IP 주소를 가용성 집합의 여러 개인 IP 주소와 공유하고, 이 공용 IP 주소의 삭제 포트를 사용합니다. 이 시나리오는 이전 시나리오의 대체 시나리오입니다. 가시성 및 제어 기능이 필요한 경우에는 권장되지 않습니다. |

VM이 공용 IP 주소 공간에 있는 Azure 외부에서 엔드포인트와 통신하지 않게 하려면 NSG(네트워크 보안 그룹)를 사용하여 필요에 따라 액세스를 차단할 수 있습니다. NSG 사용에 대한 자세한 내용은 [아웃바운드 연결 방지](#preventoutbound)에서 다룹니다. 아웃바운드 액세스 없이 가상 네트워크를 설계, 구현 및 관리하는 방법은 이 문서의 범위를 벗어납니다.

### <a name="ilpip"></a>시나리오 1: 인스턴스 수준 공용 IP 주소가 있는 VM

이 시나리오에서 VM에는 ILPIP(인스턴스 수준 공용 IP)가 할당되어 있습니다. 아웃바운드 연결에 있어서는 VM이 부하 분산되었는지 여부는 중요하지 않습니다. 이 시나리오는 다른 시나리오에 우선합니다. ILPIP가 사용되면 VM은 모든 아웃바운드 흐름에 ILPIP를 사용합니다.  

VM에 할당된 공용 IP는 1:다가 아닌 1:1 관계이며 상태 비저장 1:1 NAT로 구현됩니다.  포트 가장(PAT)은 사용되지 않으며 VM에는 사용 가능한 모든 삭제 포트가 있습니다.

애플리케이션이 아웃바운드 흐름을 시작하고 SNAT 포트 소모가 발생하는 경우 [ILPIP를 할당하여 SNAT 제약 조건을 완화](#assignilpip)하는 방안을 고려해야 합니다. [SNAT 고갈 관리](#snatexhaust)를 전체적으로 검토합니다.

### <a name="lb"></a>시나리오 2: 인스턴스 수준 공용 IP 주소가 없는 부하 분산 VM

이 시나리오에서 VM은 공용 Load Balancer 백 엔드 풀의 일부입니다. VM에는 할당된 공용 IP 주소가 없습니다. 부하 분산 장치 리소스는 공용 IP 프런트 엔드와 백 엔드 풀 간의 연결을 만드는 부하 분산 장치 규칙으로 구성해야 합니다.

이 규칙 구성을 완료하지 않으면 동작은 [인스턴스 수준 공용 IP가 없는 독립 실행형 VM](#defaultsnat)에 대한 시나리오에 설명된 대로 나타납니다. 백 엔드 풀 또는 상태 프로브에 작업 수신기가 있어야만 규칙이 성공하는 것은 아닙니다.

부하 분산 VM이 아웃바운드 흐름을 만든 경우 Azure에서는 아웃바운드 흐름의 개인 원본 IP 주소를 공용 부하 분산 장치 프론트 엔드의 공용 IP 주소로 변환합니다. Azure는 SNAT을 사용하여 이 기능을 수행합니다. 또한 Azure는 [PAT](#pat)를 사용하여 공용 IP 주소 뒤에서 여러 개인 IP 주소를 가장합니다. 

Load Balancer의 공용 IP 주소 프런트 엔드에 있는 삭제 포트는 VM에서 발생하는 개별 흐름을 구별하는 데 사용됩니다. SNAT은 아웃바운드 흐름이 생성될 때 동적으로 [삭제 포트를 미리 할당](#preallocatedports)합니다. 이 컨텍스트에서 SNAT에 사용되는 임시 포트를 SNAT 포트라고 부릅니다.

SNAT 포트는 [SNAT 및 PAT 이해](#snat) 섹션에 설명된 대로 미리 할당되며 고갈될 수 있는 한정된 리소스입니다. 어떻게 [소비](#pat)되는지 이해하는 것이 중요합니다. 이 소비를 설계하고 필요에 따라 완화하는 방법을 알아보려면 [SNAT 고갈 관리](#snatexhaust)를 검토하세요.

[여러 공용 IP 주소가 Load Balancer 기본에 연결](load-balancer-multivip-overview.md)된 경우 이러한 공용 IP 주소가 아웃바운드 흐름의 후보가 되며 그 중 하나가 임의로 선택됩니다.  

Load Balancer 기본을 사용 하 여 아웃 바운드 연결의 상태를 모니터링 하려면 사용할 수 있습니다 [부하 분산 장치에 대 한 Azure Monitor 로그](load-balancer-monitor-log.md) 하 고 [경고 이벤트 로그](load-balancer-monitor-log.md#alert-event-log) SNAT 포트 소모 메시지를 모니터링 합니다.

### <a name="defaultsnat"></a>시나리오 3: 인스턴스 수준 공용 IP 주소가 없는 독립 실행형 VM

이 시나리오에서 VM은 공용 Load Balancer 풀의 일부가 아니며(내부 표준 Load Balancer 풀의 부분이 아님) 할당된 ILPIP 주소가 없습니다. VM이 아웃바운드 흐름을 만든 경우 Azure에서는 아웃바운드 흐름의 개인 원본 IP 주소를 공용 원본 IP 주소로 변환합니다. 이 아웃바운드 흐름에 사용된 공용 IP 주소는 구성할 수 없으며 구독의 공용 IP 리소스 제한에 불리하게 작용하지 않습니다. 이 공용 IP 주소는 사용자의 소유가 아니며 예약할 수 없습니다. VM 또는 가용성 집합이나 가상 머신 확장 집합을 재배포하는 경우에는 이 공용 IP 주소가 해제되고 새 공용 IP 주소가 요청됩니다. IP 주소를 허용 목록에 추가할 때는 이 시나리오를 사용하지 말고, 아웃바운드 시나리오와 아웃바운드 연결에 사용할 공용 IP 주소를 명시적으로 선언하는 두 시나리오 중 하나를 사용하세요.

>[!IMPORTANT] 
>또한 이 시나리오는 내부 기본 Load Balancer가 연결된 경우에__만__ 적용됩니다. 시나리오 3은 내부 표준 Load Balancer가 VM에 연결된 경우에는 __사용할 수 없습니다__.  내부 표준 Load Balancer를 사용하는 것 외에도 명시적으로 [시나리오 1](#ilpip) 또는 [시나리오 2](#lb)를 만들어야 합니다.

Azure는 포트 가장([PAT](#pat))과 함께 SNAT을 사용하여 이 기능을 수행합니다. 이 시나리오는 사용되는 IP 주소를 제어할 수 없다는 점을 제외하고 [시나리오 2](#lb)와 비슷합니다. 시나리오 1 및 2가 없을 때를 대비한 시나리오입니다. 아웃바운드 주소를 제어해야 하는 경우에는 이 시나리오를 사용하지 않는 것이 좋습니다. 아웃바운드 연결이 애플리케이션의 중요한 부분인 경우 다른 시나리오를 선택해야 합니다.

SNAT 포트는 [SNAT 및 PAT 이해](#snat) 섹션에 설명된 대로 미리 할당되며  가용성 집합을 공유하는 VM의 수는 미리 할당 계층이 적용되는 것을 결정합니다.  가용성 집합이 없는 독립 실행형 VM은 사전 할당의 결정을 위한 1의 효과적인 풀입니다(1024 SNAT 포트). SNAT 포트는 소진될 수 있는 한정된 리소스입니다. 어떻게 [소비](#pat)되는지 이해하는 것이 중요합니다. 이 소비를 설계하고 필요에 따라 완화하는 방법을 알아보려면 [SNAT 고갈 관리](#snatexhaust)를 검토하세요.

### <a name="combinations"></a>여러 결합 시나리오

이전 섹션에서 설명한 시나리오를 결합하여 특정 결과를 달성할 수 있습니다. 여러 시나리오가 있는 경우 우선 순위가 적용됩니다. [시나리오 1](#ilpip)이 [시나리오 2](#lb) 및 [3](#defaultsnat)보다 우선합니다. [시나리오 2](#lb)가 [시나리오 3](#defaultsnat)을 재정의합니다.

애플리케이션이 제한된 수의 대상에 대한 아웃바운드 연결에 크게 의존하지만 Load Balancer 프런트 엔드를 통해 인바운드 흐름을 수신하는 Azure Resource Manager 배포를 예로 들 수 있습니다. 이 경우 시나리오 1과 2를 결합하면 안심할 수 있습니다. 추가 패턴은 [SNAT 고갈 관리](#snatexhaust)를 검토하세요.

### <a name="multife"></a> 아웃바운드 흐름에 대한 여러 프런트 엔드

#### <a name="standard-load-balancer"></a>표준 Load Balancer

표준 Load Balancer는 [여러 (공개) IP 프런트 엔드](load-balancer-multivip-overview.md)가 있을 때 동시에 아웃바운드 흐름에 대한 모든 후보를 사용합니다. 각 프런트 엔드는 부하 분산 규칙이 아웃바운드 연결에 대해 활성화된 경우 미리 할당된 사용 가능한 SNAT 포트 수를 곱합니다.

새 부하 분산 규칙 옵션으로 프런트 엔드 IP 주소를 아웃바운드 연결에 사용되지 않도록 선택할 수 있습니다.

```json    
      "loadBalancingRules": [
        {
          "disableOutboundSnat": false
        }
      ]
```

일반적으로 `disableOutboundSnat` 옵션의 기본값은 _false_이며 이 규칙 프로그램이 부하 분산 규칙의 백 엔드 풀에 연결된 VM에 대한 SNAT를 아웃바운드하는 것을 의미합니다. `disableOutboundSnat`을 _true_로 변경하여 Load Balancer가 이 부하 분산 규칙의 백 엔드 풀에서 VM에 대한 아웃바운드 연결에 연결된 프런트 엔드 IP 주소를 사용하지 못하게 할 수 있습니다.  또한 [여러 결합 시나리오](#combinations)에 설명된 대로 아웃바운드 흐름에 대한 특정 IP 주소를 지정할 수도 있습니다.

#### <a name="load-balancer-basic"></a>Load Balancer 기본

[여러(공개) IP 프런트 엔드](load-balancer-multivip-overview.md)가 아웃바운드 흐름의 후보인 경우 Load Balancer 기본은 아웃바운드 흐름에 단일 프런트 엔드를 사용하기로 선택합니다. 이 선택은 구성할 수 없으며 선택 알고리즘은 임의로 결정된다고 보면 됩니다. [여러 결합 시나리오](#combinations)에 설명된 대로 아웃바운드 흐름에 대한 특정 IP 주소를 지정할 수 있습니다.

### <a name="az"></a> 가용성 영역

[가용성 영역이 있는 표준 Load Balancer](load-balancer-standard-availability-zones.md)를 사용하는 경우 영역 중복 프런트 엔드는 영역 중복 아웃바운드 SNAT 연결을 제공할 수 있으며 SNAT 프로그래밍은 영역 실패를 유지합니다.  영역 프런트 엔드가 사용되는 경우 아웃바운드 SNAT 연결은 자신이 속한 영역을 공유합니다.

## <a name="snat"></a>SNAT 및 PAT 이해

### <a name="pat"></a>포트 가장 SNAT(PAT)

공용 Load Balancer 리소스가 VM 인스턴스와 연결된 경우 각 아웃바운드 연결 원본이 다시 작성됩니다. 원본은 가상 네트워크 개인 IP 주소 공간에서 부하 분산 장치의 프런트 엔드 공용 IP 주소로 다시 작성됩니다. 공용 IP 주소 공간에서 흐름의 5튜플(원본 IP 주소, 원본 포트, IP 전송 프로토콜, 대상 IP 주소, 대상 포트)은 고유해야 합니다.  포트 가장 SNAT는 TCP 또는 UDP IP 프로토콜과 함께 사용할 수 있습니다.

여러 흐름이 단일 공용 IP 주소에서 시작되므로 삭제 포트(SNAT 포트)는 개인 원본 IP 주소를 다시 작성한 후 이 목적에 사용됩니다. 포트 위장 SNAT 알고리즘은 UDP와 TCP의 SNAT 포트를 다르게 할당합니다.

#### <a name="tcp"></a>TCP SNAT 포트

단일 대상 IP 주소, 포트에 대한 흐름당 하나의 SNAT 포트가 사용됩니다. 동일한 대상 IP 주소, 포트 및 프로토콜에 대한 여러 TCP 흐름의 경우 각 TCP 흐름은 단일 SNAT 포트를 사용합니다. 이렇게 하면 흐름이 동일한 대상 IP 주소에서 시작하여 동일한 대상 IP 주소, 포트 및 프로토콜로 이동하는 경우 흐름의 고유성이 보장됩니다. 

서로 다른 대상 IP 주소, 포트 및 프로토콜에 대한 여러 흐름은 단일 SNAT 포트를 공유합니다. 대상 IP 주소, 포트 및 프로토콜은 공용 IP 주소 공간에서 흐름을 구분하는 추가 원본 포트를 사용하지 않고도 흐름을 고유하게 만들어줍니다.

#### <a name="udp"></a> UDP SNAT 포트

UDP SNAT 포트는 TCP SNAT 포트와는 다른 알고리즘을 통해 관리됩니다.  부하 분산 장치는 UDP에 "포트 제한 원뿔형 NAT"이라고 하는 알고리즘을 사용합니다.  대상 IP 주소, 포트에 관계없이 각 흐름당 하나의 SNAT 포트가 사용됩니다.

#### <a name="exhaustion"></a>고갈

SNAT 포트 리소스가 고갈되면 기존 흐름에서 SNAT 포트를 릴리스할 때까지 아웃바운드 흐름이 실패합니다. Load Balancer는 흐름이 닫히면 SNAT 포트를 회수하고 유휴 흐름에서 SNAT 포트를 회수하기 위해 [4분 유휴 시간 제한](#idletimeout)을 사용합니다.

사용되는 알고리즘의 차이로 인해 일반적으로 UDP SNAT 포트가 TCP SNAT 포트보다 훨씬 빠르게 고갈됩니다. 이러한 차이를 염두에 두고 테스트를 설계하고 규모를 결정해야 합니다.

흔히 SNAT 포트 고갈로 이어지는 조건을 완화하는 패턴은 [SNAT 관리](#snatexhaust) 섹션을 검토하세요.

### <a name="preallocatedports"></a>포트 가장 SNAT(PAT)에 대한 삭제 포트 미리 할당

Azure는 포트 가장 SNAT([PAT](#pat))을 사용할 때 백 엔드 풀의 크기에 따라 사용 가능한 미리 할당 SNAT 포트 수를 결정하는 알고리즘을 사용합니다. SNAT 포트는 특정 공용 IP 원본 주소에 사용할 수 있는 삭제 포트입니다.

동일한 수의 SNAT 포트가 UDP 및 TCP에 대해 각각 미리 할당되고 IP 전송 프로토콜별로 독립적으로 사용됩니다.  그러나 SNAT 포트 사용은 흐름이 UDP인지 아니면 TCP인지에 따라 다릅니다.

>[!IMPORTANT]
>표준 SKU SNAT 프로그래밍은 IP 전송 프로토콜별로 사용되며 부하 분산 규칙에서 파생됩니다.  TCP 부하 분산 규칙만 존재하는 경우, TCP에만 SNAT를 사용할 수 있습니다. TCP 부하 분산 규칙만 있고 UDP에 대한 아웃바운드 SNAT가 필요한 경우, 동일한 프런트 엔드 풀에서 동일한 백 엔드 풀로의 UDP 부하 분산 규칙을 만듭니다.  이렇게 하면 UDP에 대한 SNAT 프로그래밍이 트리거됩니다.  작업 규칙 또는 상태 프로브는 필요하지 않습니다.  기본 SKU SNAT는 부하 분산 규칙에 지정된 전송 프로토콜과 관계없이 항상 IP 전송 프로토콜 둘 다에 대해 SNAT를 프로그래밍합니다.

Azure는 각 VM NIC의 IP 구성에 SNAT 포트를 미리 할당합니다. 풀에 IP 구성이 추가되면 백 엔드 풀 크기에 따라 이 IP 구성에 대한 SNAT 포트가 미리 할당됩니다. 아웃바운드 흐름이 생성되면 [PAT](#pat)는 흐름이 닫히거나 [유휴 제한 시간](#idletimeout)에 도달하는 경우 이러한 포트를 동적으로 소비(미리 할당된 제한까지)하거나 해제합니다.

다음 표는 백 엔드 풀 크기 계층의 SNAT 포트 미리 할당을 보여줍니다.

| 풀 크기(VM 인스턴스) | IP 구성별로 미리 할당된 SNAT 포트|
| --- | --- |
| 1-50 | 1,024 |
| 51-100 | 512 |
| 101-200 | 256 |
| 201-400 | 128 |
| 401-800 | 64 |
| 801-1,000 | 32 |

>[!NOTE]
> [여러 프런트 엔드](load-balancer-multivip-overview.md)로 표준 Load Balancer를 사용하는 경우 각 프런트 엔드 IP 주소는 앞의 표에서 사용 가능한 SNAT 포트의 수를 곱합니다. 예를 들어 각각 별도의 프런트 엔드 IP 주소가 있는 2개의 부하 분산 규칙이 있는 50 VM의 백 엔드 풀은 IP 구성당 2048(2x1024) SNAT 포트를 사용합니다. [여러 프런트 엔드](#multife)에 대한 자세한 내용을 참조하세요.

사용 가능한 SNAT 포트 수는 연결 수에 직접 반영되지 않습니다. 여러 고유한 대상에 단일 SNAT 포트를 재사용할 수 있습니다. 포트는 흐름을 고유하게 만드는 데 필요한 경우에만 사용됩니다. 디자인 및 완화 지침은 [고갈 가능한 리소스를 관리하는 방법](#snatexhaust)에 대한 섹션과 [PAT](#pat)에 대해 설명하는 섹션을 참조하세요.

백 엔드 풀의 크기를 변경하면 설정된 흐름에 영향을 줄 수 있습니다. 백 엔드 풀 크기가 증가하여 그 다음 계층으로 전환되면 그 다음으로 큰 백 앤드 풀 계층으로 전환되는 동안 미리 할당된 SNAT 포트의 절반이 회수됩니다. 회수된 SNAT 포트와 연결된 흐름은 시간이 초과되며 다시 설정해야 합니다. 미리 할당된 포트를 사용할 수 있는 한, 새 흐름이 즉시 성공합니다.

백 엔드 풀 크기가 줄고 더 낮은 계층으로 전환되면 사용 가능한 SNAT 포트 수가 증가합니다. 이 경우 기존에 할당된 SNAT 포트와 각각의 흐름은 영향을 받지 않습니다.

SNAT 포트 할당은 IP 전송 프로토콜과 관련이 있으며(TCP 및 UDP가 별도로 유지 관리됨), 다음 조건에서 해제됩니다.

### <a name="tcp-snat-port-release"></a>TCP SNAT 포트 해제

- 서버/클라이언트가 둘 다 FIN/ACK를 보내는 경우 240초 후에 SNAT 포트가 해제됩니다.
- RST가 표시되는 경우 15초 후에 SNAT 포트가 해제됩니다.
- 유휴 시간 제한에 도달함

### <a name="udp-snat-port-release"></a>UDP SNAT 포트 해제

- 유휴 시간 제한에 도달함

## <a name="problemsolving"></a> 문제 해결 

이 섹션은 Azure의 아웃바운드 연결에서 발생할 수 있는 SNAT 고갈을 완화하는 데 도움을 주고자 합니다.

### <a name="snatexhaust"></a> SNAT(PAT) 포트 고갈 관리
[PAT](#pat)에 사용되는 [삭제 포트](#preallocatedports)는 [인스턴스 수준 공용 IP 주소 없는 독립 실행형 VM](#defaultsnat) 및 [인스턴스 수준 공용 IP 주소가 없는 부하 분산 VM](#lb)에 설명된 것처럼 고갈될 수 있는 리소스입니다.

동일한 대상 IP 주소 및 포트에 대해 많은 아웃바운드 TCP 또는 UDP 연결을 시작할 것인지 알고 있는 경우 실패하는 아웃바운드 연결을 확인하고, 지원 서비스에서 SNAT 포트([PAT](#pat)에서 사용하는 미리 할당된 [삭제 포트](#preallocatedports))가 고갈될 것이라는 알림을 받는 경우 몇 가지 일반적인 완화 옵션을 사용할 수 있습니다. 다음 옵션을 검토하고 시나리오에 가장 적합한 옵션을 결정합니다. 한 가지 이상의 옵션이 이 시나리오를 관리하는 데 도움이 될 수 있습니다.

아웃바운드 연결 동작을 이해하는 데 어려움이 있는 경우 IP 스택 통계(netstat)를 사용할 수 있습니다. 또는 패킷 캡처를 사용하여 연결 동작을 관찰하면 도움이 될 수 있습니다. 이러한 패킷 캡처는 인스턴스의 게스트 OS에서 수행할 수도 있고 [패킷 캡처용 Network Watcher](../network-watcher/network-watcher-packet-capture-manage-portal.md)를 사용할 수도 있습니다.

#### <a name="connectionreuse"></a>연결을 다시 사용하도록 애플리케이션 수정 
애플리케이션에서 연결을 다시 사용하여 SNAT에서 사용되는 사용 후 삭제 포트에 대한 수요를 줄일 수 있습니다. 이러한 효과는 연결 재사용이 기본 옵션인 HTTP/1.1 같은 프로토콜에서 특히 두드러집니다. 또한 전송으로 HTTP를 사용하는 다른 프로토콜(예: REST)도 이점을 얻을 수 있습니다. 

재사용은 언제나 각 요청에 대한 개별 원자성 TCP 연결보다 좋은 방법입니다. 재사용은 TCP 트랜잭션의 성능과 효율성을 높입니다.

#### <a name="connection pooling"></a>연결 풀링을 사용하도록 애플리케이션 수정
애플리케이션에서 연결 풀링 체계를 사용할 수 있습니다. 이 경우 요청이 고정된 연결 집합에서 내부적으로 분산됩니다(가능한 경우 각 연결이다 시 사용됨). 이 체계는 사용 중인 삭제 포트의 수를 제한하고 보다 예측 가능한 환경을 구축합니다. 또한 단일 연결이 작업에 회신하느라 사용 가능하지 않을 때 여러 동시 작업을 허용하여 요청 처리량을 늘릴 수 있습니다.  

연결 풀링은 애플리케이션을 개발하는 데 사용하는 프레임워크 또는 애플리케이션에 대한 구성 설정에 이미 존재할 수 있습니다. 연결 풀링을 연결 재사용과 결합할 수 있습니다. 그러면 여러 요청이 동일한 대상 IP 주소 및 포트에 고정되고 예측 가능한 수의 포트를 사용합니다. 또한 TCP 트랜잭션을 효율적으로 사용하여 대기 시간 및 리소스 사용량이 감소하기 때문에 요청에도 이득입니다. 여러 UDP 흐름을 관리하면 고갈 조건을 피하고 SNAT 포트 활용도를 관리할 수 있으므로 UDP 트랜잭션이 도움이 될 수 있습니다.

#### <a name="retry logic"></a>덜 적극적인 재시도 논리를 사용하도록 애플리케이션 수정
[PAT](#pat)에 사용되는 [미리 할당된 삭제 포트](#preallocatedports)가 고갈되거나 애플리케이션 오류가 발생하면 지연 및 백오프 논리 없는 적극적인 또는 무차별 대입 재시도로 인해 고갈 상태가 발생하거나 지속됩니다. 덜 적극적인 재시도 논리를 사용하여 사용 후 삭제 포트에 대한 수요를 줄일 수 있습니다. 

삭제 포트의 유휴 시간 제한은 4분입니다(조정 불가능). 다시 시도 횟수가 너무 엄격하면 고갈이 스스로 지울 수 있는 기회가 없습니다. 따라서 디자인할 때 애플리케이션이 트랜잭션을 어떤 방식으로 얼마나 자주 다시 시도하는지 고려하는 것이 중요합니다.

#### <a name="assignilpip"></a>각 VM에 인스턴스 수준 공용 IP 할당
ILPIP를 할당하면 시나리오가 [VM에 대한 인스턴스 수준 공용 IP](#ilpip)로 변경됩니다. 각 VM에 사용되는 공용 IP의 모든 삭제 포트를 VM에 사용할 수 있습니다. (공용 IP의 삭제 포트가 해당 백 엔드 풀과 연결된 모든 VM과 공유되는 시나리오와는 반대입니다.) 공용 IP 주소의 추가 비용 및 많은 수의 개별 IP 주소를 허용 목록에 포함할 때 나타날 수 있는 잠재적 영향 등이 상충되는 고려 사항일 수 있습니다.

>[!NOTE] 
>이 옵션은 웹 작업자 역할에는 사용할 수 없습니다.

#### <a name="multifesnat"></a>여러 프런트 엔드 사용

공용 표준 Load Balancer를 사용하는 경우 [아웃바운드 연결에 대한 여러 프런트 엔드 IP 주소](#multife)를 할당하고 [사용 가능한 SNAT 포트의 수를 곱합니다](#preallocatedports).  프런트 엔드의 공용 IP에 대한 SNAT의 프로그래밍을 트리거하려면 프런트 엔드 IP 구성, 규칙 및 백 엔드 풀을 만듭니다.  규칙은 작동할 필요가 없으며 상태 프로브는 성공할 필요가 없습니다.  인바운드에 대해서도 여러 프런트 엔드를 사용하는 경우(아웃바운드 외에) 안정성을 유지하기 위해 사용자 지정 상태 프로브를 사용해야 합니다.

>[!NOTE]
>대부분의 경우에서 SNAT 포트 소모는 잘못된 디자인의 징후입니다.  더 많은 프런트 엔드를 사용하기 전에 SNAT 포트를 추가하기 위해 포트를 소진하는 이유를 이해해야 합니다.  나중에 오류가 발생할 수 있는 문제를 감출 수 있습니다.

#### <a name="scaleout"></a>규모 확장

[미리 할당된 포트](#preallocatedports)는 백 엔드 풀 크기를 기준으로 할당되며, 그다음으로 큰 백 엔드 풀 크기 계층을 수용하기 위해 일부 포트를 다시 할당해야 하는 경우, 중단 시간을 최소화하기 위해 계층으로 그룹화됩니다.  지정된 계층의 최대 크기까지 백 엔드 풀을 확장하여 지정된 프런트 엔드에 대한 SNAT 포트 사용률 강도를 늘릴 수도 있습니다.  이 경우 애플리케이션이 효율적으로 확장되어야 합니다.

예를 들어 백 엔드 풀에 있는 2개의 가상 머신에서는 IP 구성당 1024개의 SNAT 포트를 사용할 수 있어 총 2048개의 SNAT 포트를 배포할 수 있습니다.  배포를 50개 가상 머신으로 늘리는 경우, 가상 머신당 미리 할당된 포트 수가 일정한 경우에도 총 51,200(50x1024)개의 SNAT 포트를 사용할 수 있습니다.  배포를 확장하려는 경우, 계층당 [미리 할당된 포트](#preallocatedports) 수를 확인하여 해당 계층의 최댓값까지 확장되도록 합니다.  앞의 예제에서 50개가 아닌 51개의 인스턴스로 확장하도록 선택한 경우, 다음 계층으로 진행하며 합계뿐 아니라 VM당 SNAT 포트 수도 줄어듭니다.

그다음으로 큰 백 엔드 풀 크기 계층으로 확장하는 경우, 할당된 포트를 다시 할당해야 하면 잠재적으로 일부 아웃바운드 연결이 시간 초과될 수 있습니다.  SNAT 포트 중 일부만 사용하는 경우 그다음으로 큰 백 엔드 풀 크기로 확장하는 것이 중요하지 않습니다.  기존 포트 절반은 다음 백 앤드 풀 계층으로 이동할 때마다 다시 할당됩니다.  이러한 경우를 방지하려면 배포를 계층 크기에 맞게 조정해야 합니다.  또는 애플리케이션이 필요에 따라 검색하고 다시 시도할 수 있게 합니다.  TCP Keepalive는 다시 할당되어 SNAT 포트가 더 이상 작동하지 않는 경우의 검색을 지원할 수 있습니다.

### <a name="idletimeout"></a>keepalive를 사용하여 아웃바운드 유휴 시간 제한 다시 설정

아웃바운드 연결에는 4분의 유휴 시간 제한이 적용됩니다. 이 시간 제한은 조정할 수 없습니다. 그러나 필요한 경우 전송(예: TCP keepalive) 또는 애플리케이션 레이어 keepalive를 사용하여 유휴 흐름을 새로 고치고 이 유휴 시간 제한을 다시 설정할 수 있습니다.  

TCP Keepalive를 사용하는 경우 연결의 한 쪽에서 사용하도록 설정하는 것으로 충분합니다. 예를 들어 서버 쪽에서만 사용하도록 설정해도 흐름의 유휴 타이머가 다시 설정되며 양쪽에서 TCP Keepalive를 시작하지 않아도 됩니다.  데이터베이스 클라이언트 서버 구성을 포함하여 애플리케이션 계층에 대한 유사한 개념이 있습니다.  서버 쪽에서 사용 가능한 애플리케이션 관련 Keepalive 옵션을 확인합니다.

## <a name="discoveroutbound"></a>VM에서 사용하는 공용 IP 검색
여러 가지 방법으로 아웃바운드 연결의 공용 원본 IP 주소를 확인할 수 있습니다. OpenDNS는 VM의 공용 IP 주소를 표시할 수 있는 서비스를 제공합니다. 

nslookup 명령을 사용하여 OpenDNS 확인자에 myip.opendns.com이라는 이름에 대한 DNS 쿼리를 전송할 수 있습니다. 서비스는 쿼리를 보내는 데 사용된 원본 IP 주소를 반환합니다. VM에서 다음 쿼리를 실행하는 경우 응답은 해당 VM에 사용되는 공용 IP입니다.

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a>아웃바운드 연결 방지
VM이 아웃바운드 흐름을 만들도록 허용하는 것이 바람직하지 않은 경우가 있습니다. 또는 아웃바운드 흐름으로 연결할 수 있는 대상 또는 인바운드 흐름을 시작할 수 있는 대상을 관리하기 위한 요구 사항이 있을 수도 있습니다. 이 경우에 [네트워크 보안 그룹](../virtual-network/security-overview.md)을 사용하여 VM에서 도달할 수 있는 대상을 관리합니다. 또한 NSG를 사용하여 인바운드 흐름을 시작할 수 있는 공용 대상을 관리할 수 있습니다.

부하 분산 VM에 NSG를 적용할 때 [서비스 태그](../virtual-network/security-overview.md#service-tags) 및 [기본 보안 규칙](../virtual-network/security-overview.md#default-security-rules)에 주의해야 합니다. VM에서 Azure Load Balancer의 상태 프로브 요청을 수신할 수 있는지 확인해야 합니다. 

NSG가 AZURE_LOADBALANCER 기본 태그의 상태 프로브 요청을 차단할 경우 VM 상태 프로브에 실패하고 VM가 표시됩니다. 부하 분산 장치는 해당 VM에 새 흐름을 보내는 작업을 중지합니다.

## <a name="limitations"></a>제한 사항
- 포털에서 부하 분산 규칙을 구성할 때 옵션으로 DisableOutboundSnat을 사용할 수 없습니다.  REST, 템플릿 또는 클라이언트 도구를 대신 사용합니다.
- VNet 및 기타 Microsoft 플랫폼 서비스가 없는 웹 작업자 역할은 사전 VNet 서비스 및 다른 플랫폼 서비스 작동 방식의 부작용으로 인해 내부 표준 Load Balancer만 사용할 때 액세스할 수 있습니다. 각 서비스 자체 또는 기본 플랫폼은 사전 통보 없이 변경될 수 있으므로 이 부작용을 사용하지 마세요. 내부 표준 Load Balancer만 사용하는 경우 원하면 명시적으로 아웃 바운드 연결을 만들어야 한다고 항상 가정해야 합니다. 이 문서에 설명된 [기본 SNAT](#defaultsnat) 시나리오 3은 사용할 수 없습니다.

## <a name="next-steps"></a>다음 단계

- [Standard Load Balancer](load-balancer-standard-overview.md)에 대해 자세히 알아보세요.
- 표준 공용 Load Balancer에 대한 [아웃바운드 규칙](load-balancer-outbound-rules-overview.md)을 자세히 알아봅니다.
- [Load Balancer](load-balancer-overview.md)에 대해 자세히 알아보세요.
- [네트워크 보안 그룹](../virtual-network/security-overview.md)에 대해 자세히 알아보세요.
- Azure의 다른 주요 [네트워킹 기능](../networking/networking-overview.md)에 대해 알아보세요.
