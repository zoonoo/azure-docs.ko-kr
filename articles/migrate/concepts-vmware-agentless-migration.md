---
title: 에이전트 없이 VMware 가상 머신 복제 개념
description: Azure Migrate에서 VMware VM의 에이전트 없는 마이그레이션과 관련된 개념을 설명합니다.
author: anvar-ms
ms.author: anvar
ms.manager: bsiva
ms.topic: conceptual
ms.date: 05/31/2021
ms.openlocfilehash: ed0560d85d267de90ff23d8aa66c1f628c90e3c6
ms.sourcegitcommit: c072eefdba1fc1f582005cdd549218863d1e149e
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 06/10/2021
ms.locfileid: "111967440"
---
# <a name="azure-migrate-agentless-migration-of-vmware-virtual-machines"></a>Azure Migrate 에이전트 없는 VMware 가상 머신 마이그레이션

이 문서에서는 Azure Migrate: 서버 마이그레이션의 에이전트 없는 마이그레이션 방법을 사용하여 VMware VM을 마이그레이션할 때의 복제 개념을 설명합니다.

## <a name="replication-process"></a>복제 프로세스

에이전트 없는 복제 옵션은 VMware 스냅샷과 VMware CBT(변경된 블록 추적) 기술을 사용하여 가상 머신 디스크에서 데이터를 복제합니다. 다음 블록 다이어그램에서는 Azure Migrate: 서버 마이그레이션 도구를 사용하여 가상 머신을 마이그레이션할 때 관련된 다양한 단계를 보여줍니다.

 ![마이그레이션 단계](./media/concepts-vmware-agentless-migration/migration-phases.png)

가상 머신의 복제를 구성하는 경우 먼저 초기 복제 단계를 진행합니다. 초기 복제 중에 VM 스냅샷이 생성되고 스냅샷 디스크의 전체 데이터 사본이 대상 구독의 관리 디스크에 복제됩니다.

VM의 초기 복제가 완료되면 복제 프로세스가 증분 복제(델타 복제) 단계로 전환됩니다. 증분 복제 단계에서는 마지막으로 완료된 복제 주기 시작 시에 발생한 데이터 변경 사항이 복제되어 복제본 관리 디스크에 작성되므로 복제가 VM에서 발생하는 변경 사항과 동기화된 상태로 유지됩니다.

VMware CBT(변경된 블록 추적) 기술은 복제 주기 간의 변경 사항을 추적하는 데 사용됩니다. 복제 주기가 시작될 때 VM 스냅샷이 생성되며 변경된 블록 추적은 현재 스냅샷과 마지막으로 성공적으로 복제된 스냅샷 간의 변경 사항을 가져오는 데 사용됩니다. VM에 대한 복제를 동기화 상태로 유지하려면 이전에 완료된 복제 주기 이후 변경된 데이터만 복제해야 합니다. 각 복제 주기가 끝나면 스냅샷이 해제되고 가상 머신에 스냅샷 통합이 수행됩니다.

복제 가상 머신에서 마이그레이션 작업을 수행하는 경우 마지막 복제 주기 이후에 남은 변경 사항을 복제하는 주문형 델타 복제 주기가 있습니다. 주문형 주기가 완료된 후 가상 머신에 해당하는 복제본 관리 디스크를 사용하여 Azure에서 가상 머신을 만듭니다. 마이그레이션/장애 조치(failover)를 트리거하기 직전에 온-프레미스 가상 머신을 종료해야 합니다. 가상 머신을 종료하면 마이그레이션 중에 데이터 손실이 발생하지 않습니다.


마이그레이션이 성공하고 VM이 Azure에서 부팅되면 VM 복제를 중지해야 합니다. 복제를 중지하면 데이터 복제 중에 생성된 중간 디스크(시드 디스크)가 삭제되며 이러한 디스크의 스토리지 트랜잭션과 관련된 추가 요금이 발생하지 않습니다.

## <a name="replication-cycles"></a>복제 주기

복제 주기는 온-프레미스 환경에서 Azure 관리 디스크로 데이터를 전송하는 주기적인 프로세스를 나타냅니다. 전체 복제 주기는 다음 단계로 구성됩니다.

1. VM과 연결된 각 디스크의 VMware 스냅샷 만들기
2. Azure의 로그 스토리지 계정에 데이터 업로드
3. 스냅샷 해제
4. VMware 디스크 통합

디스크가 통합되면 주기는 완료됩니다.

## <a name="components-involved-in-replication"></a>복제와 관련된 구성 요소

**온-프레미스 구성 요소:** Azure Migrate 어플라이언스에는 복제를 담당하는 다음 구성 요소가 있습니다.

- DRA 에이전트
- 게이트웨이 에이전트

**Azure 구성 요소:** 다음 표에서는 VMware VM 마이그레이션의 에이전트 없는 방법을 사용하는 동안에 생성되는 다양한 Azure Artifacts를 요약합니다.

| 구성 요소 | 지역 | Subscription | Description |
| --- | --- | --- | --- |
| Recovery Services 자격 증명 모음 | Azure Migrate 프로젝트 지역 | Azure Migrate 프로젝트 구독 | 데이터 복제를 오케스트레이션하는 데 사용됩니다. |
| Service Bus | 대상 지역 | Azure Migrate 프로젝트 구독 | 클라우드 서비스와 Azure Migrate 어플라이언스 간의 통신에 사용됩니다. |
| 로그 스토리지 계정 | 대상 지역 | Azure Migrate 프로젝트 구독 | 서비스에서 읽고 고객의 관리 디스크에 적용되는 복제 데이터를 저장하는 데 사용됩니다. |
| 게이트웨이 스토리지 계정 | 대상 지역 | Azure Migrate 프로젝트 구독 | 복제 중에 컴퓨터 상태를 저장하는 데 사용됩니다. |
| 주요 자격 증명 모음 | 대상 지역 | Azure Migrate 프로젝트 구독 | 로그 스토리지 계정 키를 관리하고 서비스 버스 연결 문자열을 저장합니다. |
| Azure Virtual Machine | 대상 지역 | 대상 구독 | 마이그레이션할 때 Azure에 생성된 VM |
| Azure Managed Disks | 대상 지역 | 대상 구독 | Azure VM에 연결된 관리 디스크 |
| 네트워크 인터페이스 카드 | 대상 지역 | 대상 구독 | Azure에 생성된 VM에 연결된 NIC |

## <a name="permissions-required"></a>필요한 사용 권한

처음으로 복제를 시작할 때 로그인한 사용자는 다음과 같은 역할을 할당받아야 합니다.

- Azure Migrate 프로젝트의 리소스 그룹과 대상 리소스 그룹의 소유자 또는 기여자 및 사용자 액세스 관리자

후속 복제의 경우 로그인한 사용자는 다음과 같은 역할을 할당받아야 합니다.

- Azure Migrate 프로젝트의 리소스 그룹과 대상 리소스 그룹의 소유자 또는 기여자

위에서 설명한 역할 외에도 로그인한 사용자에게는 구독 수준에서 Microsoft.Resources/subscriptions/resourceGroups/read 권한이 필요합니다.


## <a name="data-integrity"></a>데이터 무결성

모든 복제 주기에는 온-프레미스 디스크(원본 디스크)와 Azure의 복제본 디스크(대상 디스크) 간에 데이터 무결성을 보장하는 두 단계가 있습니다.

1. 먼저 원본 디스크에서 변경된 모든 섹터가 대상 디스크에 복제되는지 검증합니다. 유효성 검사는 비트맵을 통해 수행됩니다.
원본 디스크는 512바이트 섹터로 나뉩니다. 원본 디스크의 모든 섹터는 비트맵의 비트에 매핑됩니다. 데이터 복제가 시작되면 복제되어야 하는 원본 디스크의 변경된 모든 변경 블록(델타 주기)에 비트맵이 생성됩니다. 마찬가지로 데이터가 대상 Azure 디스크로 전송되면 비트맵이 생성됩니다. 데이터 전송이 성공적으로 완료되면 클라우드 서비스는 비트맵 2개를 비교하여 변경된 블록이 누락되지 않았는지 확인합니다. 비트맵 간에 불일치가 있으면 주기는 실패한 것으로 간주됩니다. 모든 주기가 다시 동기화되므로 불일치는 다음 주기에서 수정됩니다.

1. 다음으로 Azure 디스크로 전송되는 데이터가 원본 디스크에서 복제된 데이터와 동일한지 확인합니다. 업로드된 모든 변경된 블록은 압축 및 암호화된 후 로그 스토리지 계정에 Blob으로 기록됩니다. 압축하기 전에 이 블록의 체크섬을 계산합니다. 이 체크섬은 압축된 데이터와 함께 메타데이터로 저장됩니다. 압축을 풀면 데이터의 체크섬이 계산되고 원본 환경에서 계산된 체크섬과 비교됩니다. 일치하지 않으면 데이터가 Azure 디스크에 기록되지 않으며 주기는 실패한 것으로 간주됩니다. 모든 주기가 다시 동기화되므로 불일치는 다음 주기에서 수정됩니다.

## <a name="security"></a>보안

Azure Migrate 어플라이언스는 데이터를 업로드하기 전에 압축하고 암호화합니다. 데이터는 https를 통한 보안 통신 채널을 통해 전송되며 TLS 1.2 이상을 사용합니다. 또한 Azure Storage는 데이터를 클라우드에 유지할 때 자동으로 암호화합니다(미사용 시 암호화).



## <a name="migration-phase"></a>마이그레이션 단계

VM에서 복제를 수행하는 경우 가능한 상태는 거의 없습니다.

- **초기 복제(큐에 대기):** 복제(또는 마이그레이션) 중에 온-프레미스 리소스를 사용하는 다른 VM이 있으면 VM은 복제(또는 마이그레이션)할 수 있도록 큐에 대기합니다. 리소스를 사용할 수 있게 되면 이 VM이 처리됩니다.
- **초기 복제:** VM에서 초기 복제를 수행하고 있습니다. VM에서 초기 복제를 수행하는 경우에는 테스트 마이그레이션과 마이그레이션을 진행할 수 없습니다. 이 단계에서는 복제만 중지할 수 있습니다.
- **테스트 마이그레이션 보류 중:** VM이 델타 복제 단계에 있으며 이제 테스트 마이그레이션(또는 마이그레이션)을 수행할 수 있습니다.
- **마이그레이션 진행 중(큐에 대기):** 복제(또는 마이그레이션) 중에 온-프레미스 리소스를 사용하는 다른 VM이 있으면 VM은 마이그레이션할 수 있도록 큐에 대기합니다. 리소스를 사용할 수 있게 되면 이 VM에서 마이그레이션을 처리합니다.
- **마이그레이션 진행 중:** VM이 마이그레이션 중입니다. 링크를 선택하여 진행 중인 마이그레이션 작업을 확인할 수 있습니다. 이 작업은 마이그레이션의 필수 조건 확인, 가상 머신 종료(선택적 단계), 마이그레이션 준비, Azure VM 만들기, Azure VM 시작 등 5단계로 구성됩니다.
- **해당 없음:** VM이 성공적으로 마이그레이션되었거나 복제를 중지한 경우 상태가 해당 없음으로 변경됩니다. 복제를 중지하고 작업이 성공적으로 완료되면 복제 컴퓨터 목록에서 VM이 제거됩니다. 복제 마법사의 가상 머신 탭에서 VM을 찾을 수 있습니다.

> [!Note]
> 일부 VM은 스토리지 IOPS 사용으로 인한 원본 환경에 대한 영향이 최소화되도록 대기 중 상태로 전환됩니다. 이러한 VM은 다음 섹션에 설명된 일정 논리에 따라 처리됩니다.

## <a name="scheduling-logic"></a>일정 논리

VM의 복제가 구성되면 초기 복제가 예약됩니다. 그런 다음, 증분 복제(델타 복제)가 수행됩니다.

델타 복제 주기는 다음과 같이 예약됩니다.

- 첫 번째 델타 복제 주기는 초기 복제 주기가 완료된 직후에 예약됩니다.
- 다음 델타 복제 주기는 max [(이전 델타 복제 주기 시간/2), 1시간] 논리에 따라 예약됩니다.

즉, 다음 델타 복제는 1시간 후에 예약됩니다. 예를 들어 VM의 델타 복제 주기에 4시간이 걸리는 경우 다음 델타 복제 주기는 다음 시간이 아니라 2시간 안에 예약됩니다.

> [!Note]
> 초기 복제가 완료되면 일정 논리가 달라집니다. 첫 번째 델타 주기는 초기 복제가 완료된 직후에 예약되며 이후 주기는 위에 설명된 일정 논리를 따릅니다.


- 마이그레이션을 트리거하면 마이그레이션 전에 VM에 주문형 델타 복제 주기(사전 장애 조치(failover) 델타 복제 주기)가 수행됩니다.

**다양한 복제 단계에서 VM 우선 순위 지정**

- 진행 중인 VM 복제가 예약된 복제(새 복제)보다 우선 지정됩니다.
- 사전 마이그레이션(주문형 델타 복제) 주기 우선 순위가 초기 복제 주기 다음으로 가장 높습니다. 델타 복제 주기 우선 순위가 가장 낮습니다.

즉, 마이그레이션 작업이 트리거될 때마다 VM에 주문형 복제 주기가 예약되고 리소스에 대해 경쟁하는 경우에는 다른 진행 중인 복제가 수행됩니다.

**제약 조건:**

다음 제약 조건을 사용하여 SAN의 IOPS 제한을 초과하지 않도록 합니다.

- 각 Azure Migrate 어플라이언스는 52 디스크 복제를 병렬로 지원합니다.
- 각 ESXi 호스트는 디스크 8개를 지원합니다. 모든 ESXi 호스트에는 32MB NFC 버퍼가 있습니다. 따라서 호스트에서 디스크 8개를 예약할 수 있습니다(디스크마다 IR, DR에 4MB 버퍼 사용).
- 데이터 저장소마다 디스크 스냅샷이 최대 15개까지 있을 수 있습니다. 단, VM에 디스크가 15개 넘게 연결되어 있는 경우는 예외입니다.

## <a name="scale-out-replication"></a>스케일 아웃 복제

Azure Migrate는 가상 머신 500개를 동시에 복제할 수 있습니다. 가상 머신을 300개 넘게 복제하려는 경우 스케일 아웃 어플라이언스를 배포해야 합니다. 스케일 아웃 어플라이언스는 Azure Migrate 기본 어플라이언스와 비슷하지만 Azure로 데이터 전송을 지원하기 위해 게이트웨이 에이전트로만 구성됩니다. 다음 다이어그램에서는 스케일 아웃 어플라이언스를 사용하는 권장 방법을 보여줍니다.

![스케일 아웃 구성](./media/concepts-vmware-agentless-migration/scale-out-configuration.png)


기본 어플라이언스를 구성한 후 동시에 복제되는 VM이 300개가 될 때까지 언제든지 스케일 아웃 어플라이언스를 배포할 수 있습니다. 동시 복제되는 VM이 300개인 경우 계속 진행하려면 스케일 아웃 어플라이언스를 배포해야 합니다.

## <a name="stop-replication"></a>복제 중지

복제를 중지하면 복제 중에 생성된 중간 관리 디스크(시드 디스크)가 삭제됩니다. 복제가 중지된 VM을 일반적인 단계에 따라 복제하고 다시 마이그레이션할 수 있습니다.

다음 두 단계에서 복제를 중지할 수 있습니다.

-  복제가 진행 중인 경우
-  VM 마이그레이션이 완료된 경우

모범 사례로, VM이 Azure로 성공적으로 마이그레이션된 후에는 중간 관리 디스크(시드 디스크)의 스토리지 트랜잭션에 대한 추가 요금이 발생하지 않도록 복제를 항상 중지해야 합니다.

경우에 따라 복제를 중지하는 데 시간이 걸릴 수 있습니다. 복제를 중지할 때마다 진행 중인 복제 주기가 아티팩트를 삭제하기 전에 완료(VM이 델타 동기화 중인 경우에만)되기 때문입니다.

## <a name="impact-of-churn"></a>변동 영향

다음 주기를 예약하기 전에 데이터를 최대한 많은 데이터를 접을 수 있도록 각 복제 주기에서 데이터 전송량을 최소화하려고 합니다. 에이전트 없는 복제가 데이터를 접으므로 _변동 패턴_ 이 _변동_ 보다 더욱 중요합니다. 파일이 계속해서 쓰여질 때 속도는 큰 영향을 미치지 않습니다. 그러나 다른 모든 섹터가 기록되는 패턴으로 인해 다음 주기에서 높은 변동이 발생합니다.

## <a name="management-of-replication"></a>복제 관리

### <a name="throttling"></a>제한

_NetQosPolicy_ 를 사용하여 복제 대역폭을 늘리거나 줄일 수 있습니다. _NetQosPolicy_ 에서 사용할 _AppNamePrefix_ 는 "GatewayWindowsService.exe"입니다. 

다음과 같은 정책을 만들어 어플라이언스에서 복제 트래픽을 제한하는 정책을 Azure Migrate 어플라이언스에서 만들 수 있습니다.

```New-NetQosPolicy -Name "ThrottleReplication" -AppPathNameMatchCondition "GatewayWindowsService.exe" -ThrottleRateActionBitsPerSecond 1MB```

> [!NOTE]
> Azure Migrate 어플라이언스에서 동시에 복제되는 모든 VM에 적용할 수 있습니다.

또한 [샘플 스크립트](./common-questions-server-migration.md)를 사용하여 일정에 따라 복제 대역폭을 늘리거나 줄일 수 있습니다.

### <a name="blackout-window"></a>블랙 아웃 기간

Azure Migrate는 고객이 복제를 진행하지 않으려는 시간 간격을 지정할 수 있는 구성 기반 메커니즘을 제공합니다. 이 시간 간격을 블랙 아웃 기간이라고 합니다. 블랙 아웃 기간은 원본 환경 리소스가 제한적인 경우, 고객이 업무 시간 이외의 시간에만 복제를 수행하려는 경우와 같은 여러 시나리오에서 발생할 수 있습니다.

> [!NOTE]
> 복제가 일시 중지되기 전에 블랙 아웃 기간 시작 시에 기존 복제 주기가 완료됩니다.

C:\ProgramData\Microsoft Azure\Config에서 GatewayDataWorker.json 파일을 만들거나 업데이트하여 어플라이언스에 블랙 아웃 기간을 지정할 수 있습니다. 일반적인 파일 형식은 다음과 같습니다.

```
{
    
    "BlackoutWindows": "List of blackout windows"
    
}
```

    
블랙 아웃 기간 목록은 “DayOfWeek;StartTime;Duration” 형식의 “|”로 구분된 문자열입니다. 기간을 일, 시 및 분 단위로 지정할 수 있습니다. 예를 들어 블랙 아웃 기간을 다음과 같이 지정할 수 있습니다.

```
{
    
    "BlackoutWindows": "Monday;7:00;7h | Tuesday;8:00;1d7h | Wednesday;16:00;1d | Thursday;18:00;5h | Friday;13:00;8m"
    
}
```
    
위 예에 있는 첫 번째 값은 월요일 오전 7:00(어플라이언스의 시간)마다 시작하여 7시간 동안 지속되는 블랙 아웃 기간을 나타냅니다.

이러한 콘텐츠로 GatewayDataWorker.json을 만들거나 업데이트한 후 해당 변경 사항을 적용하려면 어플라이언스에서 게이트웨이 서비스를 다시 시작해야 합니다.

스케일 아웃 시나리오에서 기본 어플라이언스와 스케일 아웃 어플라이언스는 개별적으로 블랙 아웃 기간을 적용합니다. 모범 사례로, 기간을 여러 어플라이언스에서 일관되게 유지하는 것이 좋습니다.

## <a name="next-steps"></a>다음 단계
에이전트 없는 마이그레이션을 사용하여 [VMware VM을 마이그레이션](tutorial-migrate-vmware.md)합니다.