---
title: "Azure 릴레이 하이브리드 연결 프로토콜 가이드 | Microsoft Docs"
description: "Azure 릴레이 하이브리드 연결 프로토콜 가이드입니다."
services: service-bus-relay
documentationcenter: na
author: clemensv
manager: timlt
editor: 
ms.assetid: 149f980c-3702-4805-8069-5321275bc3e8
ms.service: service-bus-relay
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 03/23/2017
ms.author: sethm;clemensv
translationtype: Human Translation
ms.sourcegitcommit: 356de369ec5409e8e6e51a286a20af70a9420193
ms.openlocfilehash: a433b918f48b42d3bf7ee8ee16bd912e278a381d
ms.lasthandoff: 03/27/2017


---
# <a name="azure-relay-hybrid-connections-protocol"></a>Azure 릴레이 하이브리드 연결 프로토콜
Azure 릴레이는 Azure Service Bus 플랫폼의 주요 기능 요소 중 하나입니다. 릴레이의 새로운 "하이브리드 연결" 기능은 HTTP 및 WebSockets를 기반으로 한 안전한 오픈 프로토콜의 진화된 형태입니다. 이는 소유 프로토콜을 기반으로 빌드된 이전의 동일한 이름의 "BizTalk Services" 기능을 대체합니다. 하이브리드 연결을 Azure App Services에 통합하여 그 기능을 계속 수행합니다.

"하이브리드 연결"을 사용하면 네트워크에 연결된 두 응용 프로그램 간의 양방향 이진 스트림 통신이 가능해지며, 양 당사자 중 하나 또는 모두 NAT 또는 방화벽 뒤에 있을 수 있습니다. 이 문서에서는 수신기 및 발신자 역할에서 클라이언트를 연결하기 위해 하이브리드 연결 릴레이와 클라이언트 쪽의 상호 작용 그리고 수신기가 새 연결을 수락하는 방법에 대해 설명합니다.

## <a name="interaction-model"></a>상호 작용 모델
하이브리드 연결 릴레이는 두 당사자가 자신의 네트워크의 관점에서 검색하고 연결할 수 있는 Azure 클라우드에서 랑데부 지점을 제공하여 이 두 당사자를 연결합니다. 해당 랑데부 지점은 이 설명서와 다른 설명서에서 그리고 API 및 Azure Portal에서 "하이브리드 연결"이라고 합니다. 하이브리드 연결 서비스 끝점은 이 문서의 나머지 부분에서 "서비스"라고 지칭합니다. 상호 작용 모델은 다른 많은 네트워킹 API에 의해 정해진 용어 체계를 사용합니다.

먼저 준비 상태를 표시하여 들어오는 연결을 처리하고 이후 도착하는 대로 연결을 수락하는 수신기가 있습니다. 다른 쪽에는 양방향 통신 경로를 설정하기 위해 해당 연결을 수락하는 수신기에 연결할 연결 클라이언트가 있습니다.
"연결", "수신", "수락"은 대부분 소켓 API에서 나타나는 동일한 용어입니다.

릴레이 통신 모델에는 서비스 끝점에 대한 아웃바운드 연결을 지정하는 한쪽 당사자가 있습니다. 이렇게 하면 "수신기"도 통상적으로 "클라이언트"가 되기 때문에 많은 용어를 혼용하게 됩니다. 따라서 하이브리드 연결에 사용되는 정확한 용어는 다음과 같습니다.

연결 양쪽의 프로그램은 서비스에 대한 클라이언트이기 때문에 "클라이언트"이라고 합니다. 연결을 기다렸다가 수락하는 클라이언트는 "수신기"이며 또는 "수신기 역할"에 있다고 합니다. 서비스를 통해 수신기에 대한 새로운 연결을 시작하는 클라이언트는 "발신자" 또는 "발신자 역할"에 있다고 합니다.

### <a name="listener-interactions"></a>수신기 상호 작용
수신기에는 서비스와의 네 가지 상호 작용이 있으며, 모든 연결에 대한 세부 정보는 이 문서의 후반부 참조 섹션에 설명되어 있습니다.

#### <a name="listen"></a>수신 대기
수신기가 연결을 수락할 준비가 되었음을 나타내기 위해 아웃바운드 웹 소켓 연결을 만듭니다. 연결 핸드셰이크에는 릴레이 네임스페이스에서 구성된 하이브리드 연결 이름과 그 이름에 "수신" 권한을 부여하는 보안 토큰이 있습니다.
서비스가 웹 소켓을 수락하면 등록이 완료되고 설정된 웹 소켓은 모든 후속 상호 작용을 사용하도록 "컨트롤 채널"로서 활성 상태가 유지됩니다. 서비스는 최대 25개의 수신기를 동시에 하이브리드 연결을 허용합니다. 2개 이상의 활성 수신기가 있는 경우 들어오는 연결은 임의의 순서로 균형 조정되지만, 공평하게 배포되지 않을 수 있습니다.

#### <a name="accept"></a>수락
발신자가 서비스에 대한 새로운 연결을 열 때마다 서비스는 하이브리드 연결에 대한 활성 수신기 중 하나를 선택하여 알립니다. 알림은 연결을 수락하기 위해 수신기가 연결해야 하는 웹 소켓 끝점의 URL을 포함한 JSON 메시지로서 열린 컨트롤 채널을 통해 수신기에 보내집니다.

URL은 추가 작업 없이 수신기에 의해 직접 사용할 수 있고 또 사용해야 하며, 인코딩된 정보는 발신자가 종단 간 연결이 설정되도록 최대 30초까지 대기하는 동안만 유효합니다. URL은 한 번의 성공적인 연결 시도 대해서만 사용할 수 있습니다. 랑데부 URL로 웹 소켓 연결이 설정되면, 이 웹 소켓에서의 모든 추가 작업은 서비스의 개입 또는 해석 없이 발신자를 통해 릴레이됩니다.

#### <a name="renew"></a>갱신
수신기를 등록하고 컨트롤 채널을 관리하는 데 사용해야 하는 보안 토큰은 수신기가 활성화된 동안 만료될 수 있습니다. 토큰 만료는 지속적인 연결에 영향을 주지 않지만 만료가 발생한 시점 또는 직후에는 서비스에 의해 컨트롤 채널의 연결이 끊깁니다. "갱신" 작업은 컨트롤 채널과 연결된 토큰을 교체하기 위해 수신기가 보낼 수 있는 JSON 메시지이기 때문에 컨트롤 채널은 오랜 시간 동안 유지 관리할 수 있습니다.

#### <a name="ping"></a>Ping
컨트롤 채널이 장시간 유휴 상태로 있는 경우 부하 분산 장치 또는 NAT와 같은 중간 매개체는 TCP 연결을 끊을 수 있습니다. "Ping" 작업은 네트워크 경로의 모든 사용자에게 연결이 활성 상태임을 상기시키기 위해 채널에서 소량의 데이터를 전송함으로써 연결 끊김을 방지하며, 이것은 또한 수신기가 라이브 상태인지 확인하는 테스트이기도 합니다. Ping이 실패하는 경우 컨트롤 채널은 사용할 수 없는 것으로 간주되며 수신기를 다시 연결해야 합니다.

### <a name="sender-interaction"></a>발신자 상호작용
발신자에는 연결한 서비스와 하나의 상호 작용만 있습니다.

#### <a name="connect"></a>연결
"연결" 작업은 서비스에 대한 웹 소켓을 열어 하이브리드 연결의 이름과 쿼리 문자열에서 "발신" 권한을 부여하는 보안 토큰(선택 사항이지만 기본적으로 필요함)을 제공합니다. 그런 다음 서비스는 앞서 설명한 방법으로 수신기와 상호 작용을 하며 수신기가 이 웹 소켓과 함께 랑데부 연결을 설정합니다. 웹 소켓이 수락되면 웹 소켓의 모든 상호 작용은 연결된 수신기와 이루어집니다.

### <a name="interaction-summary"></a>상호 작용 요약
이 상호 작용 모델의 결과는 수신기에 연결되어 있고 추가 프리앰블 또는 준비가 필요 없는 "정상적인" 웹 소켓과의 핸드셰이크에서 나온 발신자 클라이언트입니다. 이렇게 하면 기존 웹 소켓 클라이언트 구현을 통해 올바르게 구성된 URL을 웹 소켓 클라이언트 계층에 제공하여 하이브리드 연결 서비스를 쉽게 활용할 수 있습니다.

수락 상호 작용을 통해 수신기가 획득한 랑데부 연결 웹 소켓도 또한 정상적이며 프레임워크의 로컬 네트워크 수신기의 "수락" 작업과 하이브리드 연결의 원격 "수락" 작업을 구분하는 일부 최소한의 추가 추상화와 함께 기존 웹 소켓 서버 구현에 전달될 수 있습니다.

## <a name="protocol-reference"></a>프로토콜 참조

이 섹션에서는 위에서 설명한 프로토콜 상호 작용의 세부 정보를 설명합니다.

모든 웹 소켓 연결은 일반적으로 일부 웹 소켓 프레임워크 또는 API에 의해 요약된 HTTPS 1.1의 업그레이드로서 포트 443에서 설정됩니다. 여기의 설명은 특정 프레임워크를 제안하지 않고 중립적으로 구현하는 방법을 설명합니다.

### <a name="listener-protocol"></a>수신기 프로토콜
수신기 프로토콜은 두 개의 연결 제스처와 세 가지 메시지 작업으로 구성됩니다.

#### <a name="listener-control-channel-connection"></a>수신기 컨트롤 채널 연결
컨트롤 채널은 다음에 연결할 웹 소켓을 만들기 위해 열립니다.

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...[&sb-hc-id=...]&sb-hc-token=...
```

`namespace-address`는 하이브리드 연결을 호스팅하는 Azure 릴레이 네임스페이스의 정규화된 도메인 이름으로, 일반적인 형태는 `{myname}.servicebus.windows.net`입니다.

쿼리 문자열 매개 변수 옵션은 다음과 같습니다.

| 매개 변수 | 필수 | 설명 |
| --- | --- | --- |
| sb-hc-action |예 |수신기 역할의 경우 매개 변수는 **sb-hc-action=listen**이어야 합니다. |
| {path} |예 |이 수신기를 등록하기 위해 미리 구성된 하이브리드 연결의 URL 인코딩 네임스페이스 경로입니다. 이 식은 고정 `$hc/` 경로 부분에 추가됩니다. |
| sb-hc-token |예\* |수신기는 네임스페이스 또는 **수신** 권한을 부여하는 하이브리드 연결의 유효한 URL 인코딩 Service Bus 공유 액세스 토큰을 제공해야 합니다. |
| sb-hc-id |아니요 |이 클라이언트 제공 옵션 ID를 사용하면 종단 간 진단 추적을 수행할 수 있습니다. |

등록되지 않은 하이브리드 연결 경로, 잘못되거나 누락된 토큰 또는 일부 다른 오류로 인해 웹 소켓 연결이 실패한 경우, 일반적인 HTTP 1.1 상태 피드백 모델을 사용하여 오류 피드백이 제공됩니다. 상태 설명에는 다음과 같이 Azure 지원에 전달될 수 있는 오류 추적 ID를 포함됩니다.

| 코드 | 오류 | 설명 |
| --- | --- | --- |
| 404 |찾을 수 없음 |하이브리드 연결 **경로**가 유효하지 않거나 기본 URL이 잘못되었습니다. |
| 401 |권한 없음 |보안 토큰은 누락되었거나 잘못되었거나 유효하지 않습니다. |
| 403 |사용할 수 없음 |보안 토큰이 이 작업의 이 경로에 대해 올바르지 않습니다. |
| 500 |내부 오류 |서비스에 오류가 발생했습니다. |

처음 설정한 이후 웹 소켓 연결이 서비스에 의해 의도적으로 종료된 경우, 추적 ID와 함께 설명이 포함된 오류 메시지와 함께 적절한 웹 소켓 프로토콜 오류 코드를 사용하여 종료된 이유가 전달됩니다. 서비스는 오류 조건이 발생하지 않는 한 컨트롤 채널을 종료하지 않습니다. 정상적인 종료는 클라이언트를 제어합니다.

| WS 상태 | 설명 |
| --- | --- |
| 1001 |하이브리드 연결 경로가 삭제되었거나 사용되지 않았습니다. |
| 1008 |보안 토큰이 만료되어 권한 부여 정책을 위반했습니다. |
| 1011 |서비스에 오류가 발생했습니다. |

### <a name="accept-handshake"></a>핸드셰이크 수락
이전에 설정된 컨트롤 채널을 통해 서비스에 의해 웹 소켓 텍스트 프레임의 JSON 메시지로서 수락 알림이 수신기에 전송됩니다. 이 메시지에 대한 회신이 없습니다.

메시지는 "수락"이라는 JSON 개체를 포함하며 이때 다음과 같은 속성을 정의합니다.

* **address** – 들어오는 연결을 수락하기 위해 서비스에 웹 소켓을 설정하는 데 사용할 URL 문자열입니다.
* **id** - 이 연결에 대한 고유 식별자입니다. 발신자 클라이언트에 의해 id가 제공된 경우 이는 발신자 제공 값이거나 시스템 생성 값입니다.
* **connectHeaders** – 발신자가 릴레이 끝점으로 보낸 모든 HTTP 헤더로, Sec-WebSocket-Protocol 및 Sec-WebSocket-Extensions 헤더를 포함합니다.

#### <a name="accept-message"></a>수락 메시지
```json
{                                                           
    "accept" : {
        "address" : "wss://168.61.148.205:443/$hc/{path}?..."    
        "id" : "4cb542c3-047a-4d40-a19f-bdc66441e736",  
        "connectHeaders" : {                                         
            "Host" : "...",                                                
            "Sec-WebSocket-Protocol" : "...",                              
            "Sec-WebSocket-Extensions" : "..."                             
        }                                                            
     }                                                         
}
```

JSON 메시지에서 제공되는 주소 URL은 발신자 소켓을 수락하거나 거부하도록 웹 소켓을 설정하기 위해 수신기에 의해 사용됩니다.

#### <a name="accepting-the-socket"></a>소켓 수락
수락하면 수신기가 제공된 주소로 웹 소켓 연결을 설정합니다.

"수락" 메시지에 "Sec-WebSocket-Protocol" 헤더가 있는 경우, 해당 프로토콜을 지원하고 웹 소켓이 설정된 대로 헤더를 설정하면 수신기는 웹 소켓만 수락합니다.

"Sec-WebSocket-Extensions" 헤더에도 동일하게 적용됩니다. 프레임워크가 확장을 지원하는 경우 확장을 위해 필수 "Sec-WebSocket-Extensions" 핸드셰이크의 *서버* 쪽 회신에 헤더를 설정해야 합니다.

URL은 수락 소켓을 설정하는 데 현재 상태로 사용되어야 하지만, 다음과 같은 매개 변수를 포함합니다.

| 매개 변수 | 필수 | 설명 |
| --- | --- | --- |
| sb-hc-action |예 |소켓을 수락하기 위해 매개 변수는 `sb-hc-action=accept`이어야 합니다. |
| {path} |예 |(다음 단락 참조) |
| sb-hc-id |아니요 |위의 **ID**를 참조하세요. |

`{path}`은 이 수신기를 등록하기 위해 미리 구성된 하이브리드 연결의 URL 인코딩 네임스페이스 경로입니다. 이 식은 고정 `$hc/` 경로 부분에 추가됩니다. 

경로 식은 분리 전달 슬래시 뒤에 등록된 이름 뒤에 접미사 및 쿼리 문자열 식으로 확장될 수도 있습니다. 이를 통해 전송기 클라이언트가 HTTP 헤더를 포함할 수 없는 경우 수용하는 수신기에 디스패치 인수를 전달할 수 있습니다. 수신기 프레임워크가 고정 경로 부분 및 경로의 등록 이름을 구문 분석하고 접두사가 "sb-"인 쿼리 문자열 인수가 없이 앱이 연결을 허용할지 여부를 결정하는 데 사용할 수 있는 나머지 부분을 만들게 됩니다.

자세한 내용은 다음 "전송기 프로토콜" 섹션을 참조하세요.

오류가 없으면 서비스는 다음과 같이 회신할 수 있습니다.

| 코드 | 오류 | 설명 |
| --- | --- | --- |
| 403 |사용할 수 없음 |URL이 올바르지 않습니다. |
| 500 |내부 오류 |서비스에 오류가 발생함 |

연결이 설정된 후, 발신자 웹 소켓이 종료될 때 또는 다음과 같은 상태일 때 서버는 웹 소켓을 종료합니다.

| WS 상태 | 설명 |
| --- | --- |
| 1001 |발신자 클라이언트가 연결을 종료합니다. |
| 1001 |하이브리드 연결 경로가 삭제되었거나 사용되지 않았습니다. |
| 1008 |보안 토큰이 만료되어 권한 부여 정책을 위반했습니다. |
| 1011 |서비스에 오류가 발생했습니다. |

#### <a name="rejecting-the-socket"></a>소켓 거부
"수락" 메시지를 검사한 후 소켓을 거부하는 경우 비슷한 핸드셰이크가 필요하므로 상태 코드와 거부 이유를 알리는 상태 설명을 발신자에게 전달할 수 있습니다.

여기의 프로토콜 디자인 선택은 웹 소켓 핸드셰이크를 사용하기 위한 것이므로(정의된 오류 상태에서 종료되도록 설계) 수신기 클라이언트는 웹 소켓 클라이언트에 의존하여 계속 구현할 수 있고 추가 및 기본 HTTP 클라이언트를 사용할 필요가 없습니다.

소켓을 거부하려면 클라이언트는 "수락" 메시지의 주소 URI를 사용하고 다음과 같이 두 가지 쿼리 문자열 매개 변수를 추가합니다.

| 매개 변수 | 필수 | 설명 |
| --- | --- | --- |
| statusCode |예 |숫자 HTTP 상태 코드 |
| statusDescription |예 |거부 이유를 읽을 수 있는 사람 |

결과 URI는 WebSocket 연결을 설정하는 데 사용됩니다.

올바르게 완료한 경우 이 핸드셰이크는 웹 소켓 설정되지 않았기 때문에 HTTP 오류 코드 410과 함께 의도적으로 실패합니다. 오류가 발생하는 경우 옵션은 다음과 같습니다.

| 코드 | 오류 | 설명 |
| --- | --- | --- |
| 403 |사용할 수 없음 |URL이 올바르지 않습니다. |
| 500 |내부 오류 |서비스에 오류가 발생했습니다. |

### <a name="listener-token-renewal"></a>수신기 토큰 갱신
수신기 토큰이 만료 직전인 경우 설정된 제어 채널을 통해 텍스트 프레임 메시지를 서비스에 전송하여 교체할 수 있습니다. 메시지는 "renewToken"이라는 JSON 개체를 포함하며 이때 다음과 같은 속성을 정의합니다.

* **token** – 네임스페이스 또는 **수신** 권한을 부여하는 하이브리드 연결의 유효한 URL 인코딩 Service Bus 공유 액세스 토큰입니다.

#### <a name="renewtoken-message"></a>renewToken 메시지
```json
{                                                                                                                                                                        
    "renewToken" : {                                                                                                                                                      
        "token" : "SharedAccessSignature sr=http%3a%2f%2fcontoso.servicebus.windows.net%2fhyco%2f&amp;sig=XXXXXXXXXX%3d&amp;se=1471633754&amp;skn=SasKeyName"  
    }                                                                                                                                                                     
}
```

토큰 유효성 검사가 실패하고 액세스가 거부된 경우 클라우드 서비스는 오류와 함께 컨트롤 채널 웹 소켓을 닫고, 그렇지 않으면 회신이 없습니다.

| WS 상태 | 설명 |
| --- | --- |
| 1008 |보안 토큰이 만료되어 권한 부여 정책을 위반했습니다. |

## <a name="sender-protocol"></a>발신자 프로토콜
발신자 프로토콜은 사실상 수신기를 설정하는 방법과 동일합니다.
목표는 종단 간 웹 소켓에 대해 최대한 투명하게 하는 것입니다. 연결할 주소는 수신기의 경우와 동일하지만 "작업"이 다르며 토큰에는 다음과 같이 다른 권한이 필요합니다.

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...&sb-hc-id=...&sbc-hc-token=...
```

*namespace-address*는 하이브리드 연결을 호스팅하는 Azure 릴레이 네임스페이스의 정규화된 도메인 이름으로, 일반적인 형태는 `{myname}.servicebus.windows.net`입니다.

요청에는 응용 프로그램 정의 헤더를 포함하여 임의의 추가 HTTP 헤더를 포함할 수 있습니다. 제공된 모든 헤더는 수신기로 전달되고 "수락" 제어 메시지의 "connectHeader" 개체에서 찾을 수 있습니다.

쿼리 문자열 매개 변수 옵션은 다음과 같습니다.

| 매개 변수 | Required? | 설명 |
| --- | --- | --- |
| sb-hc-action |예 |발신자 역할의 경우 매개 변수는 `action=connect`여야 합니다. |
| {path} |예 |(다음 단락 참조) |
| sb-hc-token |예\* |수신기는 네임스페이스 또는 **발신** 권한을 부여하는 하이브리드 연결의 유효한 URL 인코딩 Service Bus 공유 액세스 토큰을 제공해야 합니다. |
| sb-hc-id |아니요 |종단 간 진단 추적을 허용하고 수락 핸드셰이크 중 수신기에 대해 사용할 수 있는 옵션 ID입니다. |

{path}는 이 수신기를 등록하기 위해 미리 구성된 하이브리드 연결의 URL 인코딩 네임스페이스 경로입니다. 경로 식은 이후 통신할 접미사 및 쿼리 문자열 식으로 확장될 수 있습니다. 하이브리드 연결이 "hyco" 경로에서 등록된 경우 경로 식은 `hyco/suffix?param=value&...` 뒤에 여기에서 정의된 쿼리 문자열 매개 변수가 올 수 있습니다. 그러면 전체 식은 다음과 같을 수 있습니다.

```
wss://{namespace-address}/$hc/hyco/suffix?param=value&sb-hc-action=...[&sb-hc-id=...&]sbc-hc-token=...
```

경로 식은 "허용" 제어 메시지에 포함된 주소 URI에서 수신기에 전달됩니다.

등록되지 않은 하이브리드 연결 경로, 잘못되거나 누락된 토큰 또는 일부 다른 오류로 인해 웹 소켓 연결이 실패한 경우, 일반적인 HTTP 1.1 상태 피드백 모델을 사용하여 오류 피드백이 제공됩니다. 상태 설명에는 다음과 같이 Azure 지원에 전달될 수 있는 오류 추적 ID를 포함됩니다.

| 코드 | 오류 | 설명 |
| --- | --- | --- |
| 404 |찾을 수 없음 |하이브리드 연결 `path`가 유효하지 않거나 기본 URL이 잘못되었습니다. |
| 401 |권한 없음 |보안 토큰은 누락되었거나 잘못되었거나 유효하지 않습니다. |
| 403 |사용할 수 없음 |보안 토큰이 이 작업의 이 경로에 대해 올바르지 않습니다. |
| 500 |내부 오류 |서비스에 오류가 발생했습니다. |

처음 설정한 이후 웹 소켓 연결이 서비스에 의해 의도적으로 종료된 경우, 추적 ID와 함께 설명이 포함된 오류 메시지와 함께 적절한 웹 소켓 프로토콜 오류 코드를 사용하여 종료된 이유가 전달됩니다.

| WS 상태 | 설명 |
| --- | --- |
| 1000 |수신기는 소켓을 종료합니다. |
| 1001 |하이브리드 연결 경로가 삭제되었거나 사용되지 않았습니다. |
| 1008 |보안 토큰이 만료되어 권한 부여 정책을 위반했습니다. |
| 1011 |서비스에 오류가 발생했습니다. |

## <a name="next-steps"></a>다음 단계
* [릴레이 FAQ](relay-faq.md)
* [네임스페이스 만들기](relay-create-namespace-portal.md)
* [.NET 시작](relay-hybrid-connections-dotnet-get-started.md)
* [노드 시작](relay-hybrid-connections-node-get-started.md)


