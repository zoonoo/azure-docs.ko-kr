---
title: 2계층 애플리케이션을 사용한 하이브리드 연결 | Microsoft Docs
description: Azure에서 다중 계층 애플리케이션 환경을 만드는 UDR 및 가상 어플라이언스를 배포하는 방법에 대해 알아봅니다.
services: virtual-network
documentationcenter: na
author: KumudD
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: kumud
ms.openlocfilehash: c959ee3bea24955e3281feb9db66e4e0cadc8bf9
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/23/2019
ms.locfileid: "61034160"
---
# <a name="virtual-appliance-scenario"></a>가상 어플라이언스 시나리오
대규모 Azure 고객 간에 일반적인 시나리오는 온-프레미스 데이터 센터에서 후면 계층에 액세스를 허용하는 동안 인터넷에 노출된 2계층 애플리케이션을 제공해야 하는 경우입니다. 이 문서에서는 UDR(사용자 정의 경로), VPN Gateway 및 네트워크 가상 어플라이언스를 사용하여 다음 요구 사항을 충족하는 2계층 환경을 배포하는 시나리오를 설명합니다.

* 웹 애플리케이션은 공용 인터넷에서만 액세스할 수 있어야 합니다.
* 애플리케이션을 호스트하는 웹 서버는 백 엔드 애플리케이션 서버에 액세스할 수 있어야 합니다.
* 인터넷에서 웹 애플리케이션으로 이동하는 모든 트래픽은 방화벽 가상 어플라이언스를 통해야 합니다. 이 가상 어플라이언스는 인터넷 트래픽에 대해서만 사용됩니다.
* 애플리케이션 서버로 이동하는 모든 트래픽은 방화벽 가상 어플라이언스를 통해야 합니다. 이 가상 어플라이언스는 백 엔드 서버에 대한 액세스 및 VPN Gateway를 통해 온-프레미스 네트워크에서 들어오는 액세스에 사용됩니다.
* 관리자는 관리 목적으로 독점적으로 사용된 세 번째 방화벽 가상 어플라이언스를 사용하여 온-프레미스 컴퓨터에서 방화벽 가상 어플라이언스를 관리할 수 있어야 합니다.

이는 DMZ 및 보호된 네트워크를 사용한 표준 DMZ 시나리오입니다. NSG, 방화벽 가상 어플라이언스 또는 둘의 조합을 사용하여 Azure에서 이러한 시나리오를 생성할 수 있습니다. 아래 표에서는 NSG와 방화벽 가상 어플라이언스 간의 장단점 중 일부를 보여 줍니다.

|  | 장점 | 단점 |
| --- | --- | --- |
| NSG |무료입니다. <br/>Azure RBAC에 통합됩니다. <br/>ARM 템플릿에서 규칙을 만들 수 있습니다. |대규모 환경에서 복잡성이 달라질 수 있습니다. |
| 방화벽 |데이터 평면을 완벽히 제어합니다. <br/>방화벽 콘솔을 통해 중앙에서 관리합니다. |방화벽 어플라이언스의 비용이 듭니다. <br/>Azure RBAC와 통합되지 않습니다. |

아래 솔루션은 방화벽 가상 어플라이언스를 사용하여 DMZ/보호된 네트워크 시나리오를 구현합니다.

## <a name="considerations"></a>고려 사항
다음과 같이 현재 사용할 수 있는 다양한 기능을 사용하여 Azure에서 위에 설명된 환경을 배포할 수 있습니다.

* **가상 네트워크(VNet)**. Azure VNet은 온-프레미스 네트워크에 비슷한 방식으로 작동하며 문제 분리 및 트래픽 격리를 제공하기 위해 하나 이상의 서브넷으로 분할할 수 있습니다.
* **가상 어플라이언스**. 여러 파트너가 위에 설명된 세 개의 방화벽에 대해 사용할 수 있는 가상 어플라이언스를 Azure Marketplace에서 제공합니다. 
* **UDR(사용자 정의 경로)**. 경로 테이블에는 Azure 네트워킹이 VNet 내에서 패킷 흐름을 제어하는 데 사용하는 UDR이 포함될 수 있습니다. 이러한 경로 테이블을 서브넷에 적용할 수 있습니다. Azure의 최신 기능 중 하나는 Azure VNet에 들어오는 모든 트래픽을 하이브리드 연결에서 가상 어플라이언스로 전달하는 기능을 제공하는 GatewaySubnet에 경로 테이블을 적용하는 기능입니다.
* **IP 전달**. 기본적으로 Azure 네트워킹 엔진은 패킷 대상 IP 주소가 NIC IP 주소와 일치하는 경우에만 가상 NIC(네트워크 인터페이스 카드)에 패킷을 전달합니다. 따라서 UDR이 지정된 가상 어플라이언스로 패킷을 보내야 한다고 정의하는 경우 Azure 네트워킹 엔진이 해당 패킷을 삭제합니다. 패킷의 실제 대상이 아닌 VM(이 경우 가상 어플라이언스)에 패킷이 전달되도록 하려면 가상 어플라이언스에 대해 IP 전달을 사용하도록 설정해야 합니다.
* **NSG(네트워크 보안 그룹)**. 아래 예제에서는 NSG를 사용하지 않지만 이 솔루션의 서브넷 및/또는 NIC에 적용된 NSG를 사용하여 해당 서브넷 및 NIC의 내외부 트래픽을 추가로 필터링할 수 있습니다.

![IPv6 연결](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

이 예에서는 다음을 포함하는 구독이 있습니다.

* 다이어그램에 표시되지 않은 2개의 리소스 그룹 
  * **ONPREMRG**. 온-프레미스 네트워크를 시뮬레이트하는 데 필요한 모든 리소스를 포함합니다.
  * **AZURERG**. Azure 가상 네트워크 환경에 필요한 모든 리소스를 포함합니다. 
* 아래 나열된 대로 분할된 온-프레미스 데이터 센터를 가장하는 데 사용되는 **onpremvnet** 이라는 VNet
  * **onpremsn1**. 온-프레미스 서버를 가장하는 Ubuntu를 실행하는 VM(가상 머신)이 포함된 서브넷입니다.
  * **onpremsn2**. 관리자가 사용하는 온-프레미스 컴퓨터를 가장하는 Ubuntu를 실행하는 VM이 포함된 서브넷입니다.
* **azurevnet**에 터널을 유지 관리하는 데 사용되는 **onpremvnet**에 **OPFW**라는 하나의 방화벽 가상 어플라이언스
* 아래 나열된 대로 분할된 **azurevnet** 이라는 VNet
  * **azsn1**. 외부 방화벽에 독점적으로 사용되는 외부 방화벽 서브넷입니다. 모든 인터넷 트래픽이 이 서브넷을 통해 들어옵니다. 이 서브넷은 외부 방화벽에 연결된 NIC만 포함합니다.
  * **azsn2**. 인터넷에서 액세스할 수 있는 웹 서버로 실행되는 VM을 호스트하는 프런트 엔드 서브넷입니다.
  * **azsn3**. 프런트 엔드 웹 서버에서 액세스할 수 있는 백 엔드 애플리케이션 서버를 실행하는 VM을 호스트하는 백 엔드 서브넷입니다.
  * **azsn4**. 모든 방화벽 가상 어플라이언스에 대한 관리 액세스를 제공하는 데 독점적으로 사용되는 관리 서브넷입니다. 이 서브넷은 솔루션에서 사용하는 각 방화벽 가상 어플라이언스에 대한 NIC만 포함합니다.
  * **GatewaySubnet**. 다른 네트워크와 Azure Vnet 간의 연결을 제공하기 위해 ExpressRoute 및 VPN Gateway에 필요한 Azure 하이브리드 연결 서브넷입니다. 
* **azurevnet** 네트워크에 있는 3개의 방화벽 가상 어플라이언스 
  * **AZF1**. Azure에서 공용 IP 주소 리소스를 사용하여 공용 인터넷에 노출되는 외부 방화벽입니다. 3-NIC 가상 어플라이언스를 프로비전하는 어플라이언스 공급업체에서 직접 또는 Marketplace에서 얻은 템플릿이 있는지 확인해야 합니다.
  * **AZF2**. **azsn2** 및 **azsn3** 간의 트래픽을 제어하는 데 사용되는 내부 방화벽입니다. 또한 3-NIC 가상 어플라이언스입니다.
  * **AZF3**. 온-프레미스 데이터 센터에서 관리자가 액세스할 수 있고 모든 방화벽 어플라이언스를 관리하는 데 사용되는 관리 서브넷에 연결된 관리 방화벽입니다. Marketplace에서 2-NIC 가상 어플라이언스 템플릿을 찾거나 어플라이언스 공급업체로부터 직접 요청할 수 있습니다.

## <a name="user-defined-routing-udr"></a>UDR(사용자 정의 라우팅)
Azure에서 각 서브넷은 해당 서브넷에서 시작된 트래픽이 라우트되는 방법을 정의하는 데 사용된 UDR 테이블에 연결될 수 있습니다. UDR이 정의되지 않은 경우 Azure는 기본 경로를 사용하여 한 서브넷에서 다른 서브넷으로 트래픽 흐름을 허용합니다. UDR에 대한 자세한 내용은 [사용자 정의된 경로 및 IP 전달이란?](virtual-networks-udr-overview.md)을 참조하세요.

위의 마지막 요구 사항에 따라 적절한 방화벽 어플라이언스를 통해 통신이 수행되려면 **azurevnet**에서 UDR을 포함하는 다음 경로 테이블을 만들어야 합니다.

### <a name="azgwudr"></a>azgwudr
이 시나리오에서는 온-프레미스에서 Azure로 흘러가는 트래픽만 **AZF3**에 연결하여 방화벽을 관리하는 데 사용되며 해당 트래픽은 내부 방화벽 **AZF2**를 통해 이동해야 합니다. 따라서 아래와 같이 **GatewaySubnet** 에서 단 하나의 경로가 필요합니다.

| 대상 | 다음 홉 | 설명 |
| --- | --- | --- |
| 10.0.4.0/24 |10.0.3.11 |관리 방화벽 **AZF3** |

### <a name="azsn2udr"></a>azsn2udr
| 대상 | 다음 홉 | 설명 |
| --- | --- | --- |
| 10.0.3.0/24 |10.0.2.11 | **AZF2** |
| 0.0.0.0/0 |10.0.2.10 | **AZF1** |

### <a name="azsn3udr"></a>azsn3udr
| 대상 | 다음 홉 | 설명 |
| --- | --- | --- |
| 10.0.2.0/24 |10.0.3.10 |**AZF2**를 통해 앱 서버에서 웹 서버로 흐르는 **azsn2**에 대한 트래픽 허용 |

또한 온-프레미스 데이터 센터를 가장하는 **onpremvnet** 에서 서브넷에 대한 경로 테이블을 만들어야 합니다.

### <a name="onpremsn1udr"></a>onpremsn1udr
| 대상 | 다음 홉 | 설명 |
| --- | --- | --- |
| 192.168.2.0/24 |192.168.1.4 |**OPFW**를 통해 **onpremsn2**에 대한 트래픽 허용 |

### <a name="onpremsn2udr"></a>onpremsn2udr
| 대상 | 다음 홉 | 설명 |
| --- | --- | --- |
| 10.0.3.0/24 |192.168.2.4 | **onpremsn2** |
| 192.168.1.0/24 |192.168.2.4 |**OPFW**를 통해 **onpremsn1**에 대한 트래픽 허용 |

## <a name="ip-forwarding"></a>IP 전달
UDR 및 IP 전달은 Azure VNet에서 트래픽 흐름을 제어하는 데 사용되는 가상 어플라이언스를 허용하도록 조합하여 사용할 수 있는 기능입니다.  가상 어플라이언스는 방화벽이나 NAT 디바이스와 같이 네트워크 트래픽을 처리하는 데 사용되는 애플리케이션을 실행하는 VM일 뿐입니다.

이 가상 어플라이언스 VM은 주소가 자신으로 지정되지 않은 들어오는 트래픽을 받을 수 있어야 합니다. VM이 다른 대상으로 주소가 지정된 트래픽을 받을 수 있도록 하려면 해당 VM에서 IP 전달을 사용하도록 설정해야 합니다. 이것은 Azure 설정으로 게스트 운영 체제에서 설정할 수 없습니다. 가상 어플라이언스는 들어오는 트래픽을 처리하고 적절하게 라우팅하기 위해 일부 유형의 애플리케이션을 계속 실행해야 합니다.

IP 전달에 대한 자세한 내용은 [사용자 정의된 경로 및 IP 전달이란](virtual-networks-udr-overview.md)을 참조하세요.

예를 들어 Azure vnet에서 다음과 같이 설정한다고 가정해 봅니다.

* 서브넷 **onpremsn1**은 **onpremvm1**이라는 VM을 포함합니다.
* 서브넷 **onpremsn2**은 **onpremvm2**이라는 VM을 포함합니다.
* **OPFW**라는 가상 어플라이언스는 **onpremsn1** 및 **onpremsn2**에 연결되어 있습니다.
* **onpremsn1**에 연결된 사용자 정의 경로에는 **onpremsn2**에 대한 모든 트래픽이 **OPFW**로 전송되어야 한다고 지정합니다.

이때 **onpremvm1**이 **onpremvm2**와 연결을 설정하려는 경우 UDR이 사용되고 다음 홉으로 트래픽은 **OPFW**에 전송됩니다. 실제 패킷 대상은 변경되지 않고 여전히 **onpremvm2** 가 대상입니다. 

**OPFW**에 대해 IP 전달을 사용하도록 설정하지 않으면 Azure 가상 네트워크 논리가 패킷을 삭제합니다. 이는 Azure 가상 네트워크가 VM(VM의 IP 주소가 패킷의 대상인 경우)에 보내는 패킷만 허용하기 때문입니다.

IP 전달을 사용하면 Azure 가상 네트워크 논리가 원래 대상 주소를 변경하지 않고 OPFW에 패킷을 전달합니다. **OPFW** 는 패킷을 처리하고 수행할 작업을 결정해야 합니다.

위 시나리오가 작동하려면 라우트에 사용되는 **OPFW**, **AZF1**, **AZF2** 및 **AZF3**에 대한 NIC(관리 서브넷에 연결된 NIC를 제외한 모든 NIC)에서 IP 전달을 사용하도록 설정해야 합니다. 

## <a name="firewall-rules"></a>방화벽 규칙
위에서 설명한 대로 IP 전달은 패킷이 가상 어플라이언스에 전송되는지만 확인합니다. 어플라이언스는 여전히 해당 패킷으로 수행할 작업을 결정해야 합니다. 위의 시나리오에서 어플라이언스에 다음 규칙을 만들어야 합니다.

### <a name="opfw"></a>onpremsn2
OPFW는 다음 규칙을 포함하는 온-프레미스 디바이스를 나타냅니다.

* **경로**: 모든 트래픽이 10.0.0.0/16 (**azurevnet**) 터널을 통해 전송 해야 **ONPREMAZURE**합니다.
* **정책**: 간의 모든 양방향 트래픽을 허용 **port2** 하 고 **ONPREMAZURE**합니다.

### <a name="azf1"></a>AZF1
AZF1은 다음 규칙을 포함하는 Azure 가상 어플라이언스를 나타냅니다.

* **정책**: 간의 모든 양방향 트래픽을 허용 **port1** 하 고 **port2**합니다.

### <a name="azf2"></a>AZF2
AZF2는 다음 규칙을 포함하는 Azure 가상 어플라이언스를 나타냅니다.

* **경로**: 모든 트래픽이 10.0.0.0/16 (**onpremvnet**)로 보내야 Azure 게이트웨이 IP 주소 (예: 10.0.0.1)를 통해 **port1**합니다.
* **정책**: 간의 모든 양방향 트래픽을 허용 **port1** 하 고 **port2**합니다.

## <a name="network-security-groups-nsgs"></a>NSG(네트워크 보안 그룹)
이 시나리오에서 NSG는 사용되지 않습니다. 그러나 들어오고 나가는 트래픽을 제한하기 위해 각 서브넷에 NSG를 적용할 수 있습니다. 예를 들어 외부 FW 서브넷에 다음 NSG 규칙을 적용할 수 있습니다.

**수신**

* 서브넷의 모든 VM에서 포트 80에 대한 인터넷에서 오는 모든 TCP 트래픽을 허용합니다.
* 인터넷에서 오는 다른 모든 트래픽을 거부합니다.

**발신**

* 인터넷으로 가는 모든 트래픽을 거부합니다.

## <a name="high-level-steps"></a>대략적인 단계
이 시나리오를 배포하려면 아래 요약된 단계를 수행합니다.

1. Azure 구독에 로그인합니다.
2. 온-프레미스 네트워크를 가장하는 VNet을 배포하려는 경우 **ONPREMRG**에 포함된 리소스를 프로비전합니다.
3. **AZURERG**에 포함된 리소스를 프로비전합니다.
4. **onpremvnet**에서 **azurevnet**으로 터널을 프로비전합니다.
5. 모든 리소스를 프로비전한 후 **onpremvm2** 로그온하고 10.0.3.101을 ping하여 **onpremsn2**와 **azsn3** 사이의 연결을 테스트합니다.

