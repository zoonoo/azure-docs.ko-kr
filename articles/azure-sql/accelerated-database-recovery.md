---
title: 가속 데이터베이스 복구
titleSuffix: Azure SQL
description: 가속화 된 데이터베이스 복구는 Azure SQL 포트폴리오의 데이터베이스에 대해 빠르고 일관 된 데이터베이스 복구, 즉시 트랜잭션 롤백 및 적극적 로그 잘림을 제공 합니다.
ms.service: sql-database
ms.subservice: high-availability
ms.custom: sqldbrb=4
ms.devlang: ''
ms.topic: conceptual
author: mashamsft
ms.author: mathoma
ms.reviewer: carlrab
ms.date: 05/19/2020
ms.openlocfilehash: a6d95bbcb0873086a799dcf216beab4a6b0d33de
ms.sourcegitcommit: 877491bd46921c11dd478bd25fc718ceee2dcc08
ms.contentlocale: ko-KR
ms.lasthandoff: 07/02/2020
ms.locfileid: "84344699"
---
# <a name="accelerated-database-recovery-in-azure-sql"></a>Azure SQL의 가속화 데이터베이스 복구 
[!INCLUDE[appliesto-sqldb-sqlmi](includes/appliesto-sqldb-sqlmi.md)]

**ADR (가속화 된 데이터베이스 복구)** 는 데이터베이스 엔진 복구 프로세스를 다시 SQL Server 디자인 하 여 데이터베이스 가용성을 크게 향상 하는 SQL Server 데이터베이스 엔진 기능입니다. 특히 장기 실행 트랜잭션이 있는 경우에는 데이터베이스의 가용성을 크게 향상 시킬 수 있습니다. ADR는 현재 azure VM의 Azure SQL Database, Azure SQL Managed Instance, SQL Server, azure Synapse Analytics의 데이터베이스 (현재 미리 보기 상태)에서 사용할 수 있습니다. ADR의 주요 이점은 다음과 같습니다.

- **빠르고 일관된 데이터베이스 복구**

  ADR을 사용하면 장기 실행 트랜잭션이 전체 복구 시간에 영향을 주지 않으므로 시스템의 활성 트랜잭션 수 또는 크기에 관계없이 빠르고 일관된 데이터베이스 복구를 사용할 수 있습니다.

- **즉시 트랜잭션 롤백**

  ADR을 사용하면 트랜잭션이 활성 상태인 시간 또는 수행된 업데이트 수와 관계없이 트랜잭션 롤백이 즉시 수행됩니다.

- **적극적인 로그 잘림**

  ADR를 사용 하면 활성 장기 실행 트랜잭션이 있는 경우에도 트랜잭션 로그가 적극적으로 잘립니다 .이로 인해 제어 기능이 증가 하지 않습니다.

## <a name="standard-database-recovery-process"></a>표준 데이터베이스 복구 프로세스

데이터베이스 복구는 [ARIES](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) 복구 모델을 따르며, 다음 다이어그램에 설명 되어 있는 세 단계로 구성 되며 다이어그램 다음에 자세히 설명 되어 있습니다.

![현재 복구 프로세스](./media/accelerated-database-recovery/current-recovery-process.png)

- **분석 단계**

  마지막으로 성공한 검사점 (또는 가장 오래 된 더티 페이지 LSN)의 시작 부분에서 트랜잭션 로그를 앞으로 검색 하 여 데이터베이스가 중지 된 시점의 각 트랜잭션 상태를 확인 합니다.

- **다시 실행 단계**

  종료 될 때까지 커밋되지 않은 가장 오래 된 트랜잭션에서 트랜잭션 로그를 검색 하 여 모든 커밋된 작업을 다시 실행 하 여 데이터베이스를 크래시 시점의 상태로 전환 합니다.

- **실행 취소 단계**

  크래시 당시 활성 상태였던 각 트랜잭션에 대해 로그를 역방향으로 트래버스하고, 이 트랜잭션이 수행한 작업을 실행 취소합니다.

이 디자인을 기반으로 SQL Server 데이터베이스 엔진이 예기치 않게 다시 시작 되는 것을 복구 하는 데 걸리는 시간은 충돌 시 시스템에서 가장 오래 된 활성 트랜잭션의 크기에 비례 합니다. 복구하려면 불완전한 모든 트랜잭션을 롤백해야 합니다. 필요한 시간은 트랜잭션이 수행한 작업과 활성 상태였던 시간에 비례합니다. 따라서 복구 프로세스는 장기 실행 트랜잭션이 있을 때 시간이 오래 걸릴 수 있습니다 (예: 대규모 테이블에 대 한 대량 삽입 작업 또는 인덱스 작성 작업).

또한 이 디자인을 기반으로 대형 트랜잭션을 취소/롤백하는 경우 위에서 설명한 것과 동일한 복구 실행 취소 단계를 사용하므로 시간이 오래 걸릴 수 있습니다.

또한 장기 실행 트랜잭션이 있는 경우에는 해당 로그 레코드가 복구 및 롤백 프로세스에 필요 하기 때문에 SQL Server 데이터베이스 엔진에서 트랜잭션 로그를 잘라낼 수 없습니다. 이러한 SQL Server 데이터베이스 엔진 디자인의 결과로 일부 고객은 트랜잭션 로그의 크기가 매우 커지고 많은 양의 드라이브 공간을 사용 하는 문제를 직면 하는 데 사용 됩니다.

## <a name="the-accelerated-database-recovery-process"></a>가속 데이터베이스 복구 프로세스

ADR는 SQL Server 데이터베이스 엔진 복구 프로세스를 완전히 다시 디자인 하 여 위의 문제를 해결 합니다.

- 가장 오래된 활성 트랜잭션의 시작 부분에서 로그를 검색할 필요가 없도록 하여 시간/인스턴트를 일정하게 만듭니다. ADR를 사용 하는 경우 트랜잭션 로그는 마지막으로 성공한 검사점 (또는 가장 오래 된 더티 페이지 LSN (로그 시퀀스 번호)) 에서만 처리 됩니다. 따라서 복구 시간은 장기 실행 트랜잭션의 영향을 받지 않습니다.
- 전체 트랜잭션에 대한 로그를 더 이상 처리할 필요가 없기 때문에 필요한 트랜잭션 로그 공간을 최소화합니다. 결과적으로 트랜잭션 로그는 검사점 및 백업이 발생될 때 적극적으로 잘릴 수 있습니다.

상위 수준에서 ADR은 모든 물리적 데이터베이스 수정의 버전을 관리하고 제한적이면서 거의 즉시 실행 취소할 수 있는 논리 연산만 실행 취소하여 빠른 데이터베이스 복구를 달성합니다. 크래시 당시 활성 상태였던 트랜잭션은 중단된 것으로 표시되며, 따라서 이러한 트랜잭션을 통해 생성된 버전을 동시 사용자 쿼리에서 무시할 수 있습니다.

ADR 복구 프로세스는 현재 복구 프로세스와 동일한 3단계로 이루어져 있습니다. 이러한 단계가 ADR에서 작동하는 원리는 다음 다이어그램에 표시되어 있으며, 그 뒤에 자세한 설명이 이어집니다.

![ADR 복구 프로세스](./media/accelerated-database-recovery/adr-recovery-process.png)

- **분석 단계**

  이 프로세스는 다른 버전의 작업에 대해 sLog를 다시 만들고 로그 레코드를 복사 하는 것과 동일 하 게 유지 됩니다.
  
- **다시 실행** 단계

  두 단계(P)로 나뉩니다.
  - 1단계

      sLog(마지막 검사점까지 가장 오래된 커밋되지 않은 트랜잭션)에서 다시 실행합니다. 다시 실행은 sLog에서 몇 개의 레코드만 처리하면 되므로 빠른 작업입니다.

  - 2단계

     트랜잭션 로그에서 다시 실행은 마지막 검사점(커밋되지 않은 가장 오래된 트랜잭션 대신)에서 시작됩니다.

- **실행 취소 단계**

   ADR을 사용한 실행 취소 단계는 sLog를 사용하여 논리적 되돌리기로 버전이 지정되지 않은 작업 및 PVS(지속형 버전 저장소)를 실행 취소함으로써 행 수준 버전 기반 실행 취소를 수행하여 거의 즉시 완료됩니다.

## <a name="adr-recovery-components"></a>ADR 복구 구성 요소

ADR의 네 가지 주요 구성 요소는 다음과 같습니다.

- **지속형 버전 저장소 (PVS)**

  지속형 버전 저장소는 기존 버전 저장소 대신 데이터베이스 자체에 생성 된 행 버전을 유지 하기 위한 새로운 SQL Server 데이터베이스 엔진 메커니즘입니다 `tempdb` . PVS는 리소스 격리를 지원할 뿐 아니라 읽기 가능 보조 복제본의 가용성을 향상합니다.

- **논리적 되돌리기**

  논리적 되돌리기는 모든 버전의 작업에 대해 즉시 트랜잭션 롤백 및 실행 취소를 제공 하는 행 수준 버전 기반 실행 취소를 수행 하는 비동기 프로세스입니다. 논리적 되돌리기 작업은 다음을 수행 합니다.

  - 중단 된 모든 트랜잭션을 추적 하 고 다른 트랜잭션에 표시 되지 않는 상태로 표시 
  - 트랜잭션 로그를 물리적으로 검사 하 고 변경 내용을 한 번에 하나씩 취소 하지 않고 모든 사용자 트랜잭션에 대해 PVS를 사용 하 여 롤백을 수행 합니다.
  - 트랜잭션이 중단 된 직후 모든 잠금을 해제 합니다. Abort는 단순히 메모리의 변경 내용만 표시 하므로 프로세스가 매우 효율적 이므로 잠금을 오랫동안 보유 하지 않아도 됩니다.

- **sLog**

  sLog는 버전이 없는 작업(예: 메타데이터 캐시 무효화, 잠금 획득 등)에 대한 로그 레코드를 저장하는 보조 메모리 내 로그 스트림입니다. sLog는 다음과 같습니다.

  - 적은 볼륨 및 메모리 내
  - 검사점 프로세스 중에 직렬화되어 디스크에 유지됩니다.
  - 트랜잭션이 커밋될 때 정기적으로 잘립니다.
  - 버전이 없는 작업만 처리하여 다시 실행 및 실행 취소를 가속화합니다.  
  - 필요한 로그 레코드만 유지하여 적극적인 트랜잭션 로그 잘림을 가능하게 합니다.

- **클리너**

  클리너는 정기적으로 절전 모드를 해제하고 필요하지 않은 페이지 버전을 정리하는 비동기 프로세스입니다.

## <a name="accelerated-database-recovery-patterns"></a>가속화 데이터베이스 복구 패턴

다음 유형의 워크 로드는 ADR에서 가장 큰 혜택을 제공 합니다.

- 장기 실행 트랜잭션이 있는 작업
- 활성 트랜잭션이 트랜잭션 로그를 크게 증가 시키는 경우를 표시 한 작업입니다.  
- 장기 실행 복구 (예: 예기치 않은 서비스 다시 시작 또는 수동 트랜잭션 롤백)로 인해 데이터베이스를 사용할 수 없는 장기간 발생 한 작업입니다.
