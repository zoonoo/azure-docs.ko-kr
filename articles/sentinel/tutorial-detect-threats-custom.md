---
title: Azure 센티널을 사용 하 여 위협을 검색 하는 사용자 지정 분석 규칙 만들기 | Microsoft Docs
description: 이 자습서를 사용 하 여 Azure 센티널에서 보안 위협을 검색 하는 사용자 지정 분석 규칙을 만드는 방법을 알아봅니다. 이벤트 그룹화 및 경고 그룹화를 활용 하 고 자동 사용 안 함을 이해 합니다.
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/06/2020
ms.author: yelevin
ms.openlocfilehash: 55853cc6a3dc27df4c63e0a28ab079813040e45d
ms.sourcegitcommit: 829d951d5c90442a38012daaf77e86046018e5b9
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 10/09/2020
ms.locfileid: "91617182"
---
# <a name="tutorial-create-custom-analytics-rules-to-detect-threats"></a>자습서: 위협 검색을 위한 사용자 지정 분석 규칙 만들기

[데이터 원본을](quickstart-onboard.md)   Azure 센티널에 연결한 후에는 사용자 환경에서 특정 기준을 검색 하 고 해당 조건이 일치 하는 경우 조사를 수행할 수 있도록 인시던트를 생성할 수 있는 사용자 지정 규칙을 만들 수 있습니다. 이 자습서에서는 사용자 지정 규칙을 만들어 Azure 센티널에서 위협을 검색 하는 방법을 안내 합니다.

이 자습서는 Azure 센티널로 위협을 검색 하는 데 도움이 됩니다.
> [!div class="checklist"]
> * 분석 규칙 만들기
> * 위협 응답 자동화

## <a name="create-custom-analytics-rules"></a>사용자 지정 분석 규칙 만들기

사용자 환경에서 의심 스러운 위협 및 비정상 유형을 검색 하는 데 도움이 되는 사용자 지정 분석 규칙을 만들 수 있습니다. 규칙은 사용자에 게 즉시 알림이 표시 되도록 하 여 위협을 심사 하 고 조사 하 고 수정할 수 있습니다.

1. Azure Sentinel 아래의 Azure Portal에서 **Analytics**를 선택합니다.

1. 상단 메뉴 모음에서 **+ 만들기** 를 선택 하 고 **예약 된 쿼리 규칙**을 선택 합니다. 그러면 **분석 규칙 마법사**가 열립니다.

    :::image type="content" source="media/tutorial-detect-threats-custom/create-scheduled-query.png" alt-text="예약 된 쿼리 만들기":::

1. **일반** 탭에서 고유한 **이름** 및 **설명**을 입력 합니다. **전술** 필드에서 규칙을 분류 하기 위한 공격 범주 중에서 선택할 수 있습니다. 필요에 따라 경고 **심각도** 를 설정 합니다. 규칙을 만들 때 **상태** 는 기본적으로 **사용 하도록 설정** 되어 있습니다. 즉, 규칙 만들기를 완료 한 후 즉시 실행 됩니다. 즉시 실행 하지 않으려면 **사용 안 함**을 선택 합니다. 규칙은 **활성 규칙** 탭에 추가 되 고 필요할 때 해당 규칙에서 사용 하도록 설정할 수 있습니다.

    ![사용자 지정 분석 규칙 만들기 시작](media/tutorial-detect-threats-custom/general-tab.png)

1. **규칙 논리 설정** 탭에서 **규칙 쿼리** 필드에 직접 쿼리를 작성 하거나 Log Analytics에서 쿼리를 만든 다음 복사 하 여 붙여 넣을 수 있습니다.
 
   ![Azure 센티널에서 쿼리 만들기](media/tutorial-detect-threats-custom/settings-tab.png)

   - 오른쪽의 **결과 미리 보기** 영역을 참조 하세요. 여기서 Azure 센티널은 쿼리가 생성 하는 결과 (로그 이벤트)의 수를 표시 하 고 쿼리를 작성 하 고 구성 하는 즉시 변경 합니다. 그래프는 **쿼리 일정** 섹션의 설정에 따라 결정 되는 정의 된 기간 동안의 결과 수를 보여 줍니다.
    - 쿼리에서 너무 많거나 너무 자주 발생 하는 경고를 트리거하는 경우에는 **경고 임계값** 섹션에서 기준을 설정할 수 있습니다.

      Azure 활동에서 비정상 리소스를 만들 때 경고를 표시 하는 샘플 쿼리는 다음과 같습니다.

      ```kusto
      AzureActivity
      | where OperationName == "Create or Update Virtual Machine" or OperationName =="Create Deployment"
      | where ActivityStatus == "Succeeded"
      | make-series dcount(ResourceId)  default=0 on EventSubmissionTimestamp in range(ago(7d), now(), 1d) by Caller
      ```

        > [!NOTE]
        > 쿼리 길이는 1 ~ 007e; 1만 자 여야 하며 "search \* " 또는 "union"을 포함할 수 없습니다 \* .

    1. **엔터티 매핑** 섹션을 사용 하 여 쿼리 결과의 매개 변수를 Azure 센티널에서 인식할 수 있는 엔터티로 연결 합니다. 이러한 엔터티는 **인시던트 설정** 탭에서 인시던트에 경고를 그룹화 하는 등 추가 분석을 위한 기반을 형성 합니다.
  
    1. **쿼리 일정** 섹션에서 다음 매개 변수를 설정 합니다.

       1. 쿼리가 실행 되는 빈도 (5 분 마다, 하루에 한 번)를 제어 하려면 **매번 쿼리 실행** 을 설정 합니다.

       1. **마지막에서 조회 데이터** 를 설정 하 여 쿼리가 적용 되는 데이터의 기간을 결정 합니다. 예를 들어 지난 10 분의 데이터 또는 지난 6 시간의 데이터를 쿼리할 수 있습니다.

          > [!NOTE]
          > **쿼리 간격 및 lookback 기간**
          > - 이러한 두 설정은 한 지점까지 서로 독립적입니다. 간격 보다 긴 시간 동안 쿼리를 실행할 수 있지만 (겹치는 쿼리를 포함 하는 경우), 검사 기간을 초과 하는 간격으로 쿼리를 실행할 수 없습니다. 그렇지 않으면 전체 쿼리 범위에서 간격이 발생할 수 있습니다.
          >
          > **수집 지연**
          > - 원본에서 이벤트를 생성 하 고 Azure 센티널에 수집 하는 동안 발생할 수 있는 **대기 시간** 을 고려 하 여 데이터 중복 없이 전체 검사를 보장 하기 위해 azure 센티널은 예약 된 시간부터 **5 분 지연** 시간에 예약 된 분석 규칙을 실행 합니다.

    1. **경고 임계값** 섹션을 사용 하 여 기준을 정의 합니다. 예를 들어 쿼리가 실행 될 때마다 반환 되는 결과 수를 1000 반환 하 **는 경우에** 만 경고를 생성 하는 경우 1000에만 경고를 생성 하는 경우에 **경고 생성** 을 설정 합니다. 이 필드는 필수 필드 이므로 기준을 설정 하지 않으려는 경우 (즉, 경고에서 모든 이벤트를 등록 하려는 경우) 숫자 필드에 0을 입력 합니다.
    
    1. **이벤트 그룹화**에서 다음 두 가지 방법 중 하나를 선택 하 여 **이벤트** 그룹화를 **경고**로 처리 합니다. 

       - **모든 이벤트를 단일 경고** (기본 설정)로 그룹화 합니다. 이 규칙은 실행 될 때마다 단일 경고를 생성 하 고, 쿼리가 지정 된 **경고 임계값** 보다 많은 결과를 반환 하는 경우에 한 합니다. 경고에는 결과에 반환 된 모든 이벤트에 대 한 요약이 포함 됩니다. 

       - **각 이벤트에 대 한 경고를 트리거합니다**. 규칙은 쿼리에서 반환 된 각 이벤트에 대해 고유한 경고를 생성 합니다. 이 방법은 이벤트를 개별적으로 표시 하거나 사용자, 호스트 이름 또는 다른 특정 매개 변수를 기준으로 이벤트를 그룹화 하려는 경우에 유용 합니다. 쿼리에서 이러한 매개 변수를 정의할 수 있습니다.
    
       현재 규칙에서 생성할 수 있는 경고 수는 20 개입니다. 특정 규칙에서 **이벤트 그룹화** 가 **각 이벤트에 대 한 경고를 트리거하기**로 설정 되 고 규칙의 쿼리에서 20 개 이상의 이벤트를 반환 하는 경우 처음 19 개의 이벤트는 각각 고유한 경고를 생성 하 고 20 번째 경고는 반환 된 이벤트의 전체 집합을 요약 합니다. 즉, 20 번째 경고는 **모든 이벤트를 단일 경고로 그룹화** 옵션에서 생성 된 것입니다.

       > [!NOTE]
       > **이벤트** 와 **경고**의 차이점은 무엇 인가요?
       >
       > - **이벤트** 는 단일 항목에 대 한 설명입니다. 예를 들어 로그 파일의 단일 항목은 이벤트로 계산 될 수 있습니다. 이 컨텍스트에서 이벤트는 분석 규칙의 쿼리에서 반환 되는 단일 결과를 나타냅니다.
       >
       > - **경고** 는 함께 수행 되는 이벤트 모음으로, 보안 관점에서 중요 합니다. 예를 들어, 이벤트의 보안 영향이 중요 한 경우 (예: 사무실 시간 외의 외부 국가에서 관리 로그인) 단일 이벤트가 경고에 포함 될 수 있습니다.
       >
       > - 이 방법으로 **인시던트**는 무엇 인가요? Azure 센티널의 내부 논리는 **경고 또는 경고** 그룹에서 **인시던트** 를 만듭니다. 인시던트 큐는 분석가의 작업 심사, 조사 및 수정의 초점입니다.
       > 
       > Azure 센티널은 일부 데이터 원본에서 원시 이벤트를 수집 다른 사람의 경고를 이미 처리 했습니다. 언제 든 지 처리 하는 항목을 확인 하는 것이 중요 합니다.

       > [!IMPORTANT]
       > 이벤트 그룹화는 현재 공개 미리 보기로 제공 됩니다. 이 기능은 서비스 수준 계약 없이 제공 되며 프로덕션 워크 로드에는 권장 되지 않습니다. 자세한 내용은 [Microsoft Azure Preview에 대한 추가 사용 약관](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)을 참조하세요.
    
    1. 경고를 받은 후 쿼리 간격을 초과 하는 기간 동안이 규칙의 작업을 일시 중단 하려는 **경우에는** **억제** 섹션에서 **경고 생성 후 쿼리 실행 중지** 설정을 켤 수 있습니다. 이 옵션을 설정 하는 경우 실행 중지 **쿼리** 를 쿼리 실행을 중지 해야 하는 시간 (최대 24 시간)으로 설정 해야 합니다.

1. **인시던트 설정** 탭에서 Azure 센티널이 경고를 조치 가능한 인시던트에 설정 하는지 여부와 방법을 선택할 수 있습니다. 이 탭만 있으면 Azure 센티널은 각 및 경고에서 별도의 단일 인시던트를 만듭니다. 이 탭의 설정을 변경 하 여 인시던트를 만들지 않거나 여러 경고를 단일 인시던트에 그룹화 하도록 선택할 수 있습니다.

   > [!IMPORTANT]
   > 인시던트 설정 탭은 현재 공개 미리 보기로 제공 됩니다. 이 기능은 서비스 수준 계약 없이 제공 되며 프로덕션 워크 로드에는 권장 되지 않습니다. 자세한 내용은 [Microsoft Azure Preview에 대한 추가 사용 약관](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)을 참조하세요.
    
    1. **인시던트 설정** 섹션에서 **이 분석 규칙에 의해 트리거된 경고에서 인시던트 만들기** 가 기본적으로 **사용**으로 설정 됩니다. 즉, Azure 센티널은 규칙에 의해 트리거되는 각 경고와 개별 인시던트 하나를 만듭니다.
       - 이 규칙을 사용 하 여 인시던트가 생성 되는 것을 원하지 않는 경우 (예:이 규칙이 후속 분석에 대 한 정보를 수집 하는 경우) **사용 안 함**으로 설정 합니다.

    1. **경고 그룹화** 섹션에서 유사 하거나 반복 되는 경고 150의 그룹에서 단일 인시던트를 생성 하려는 경우 (참고 참조), **이 분석 규칙에 의해 트리거된 그룹 관련 경고** 를 설정 된 인시던트에 **설정 하**고 다음 매개 변수를 설정 합니다.

    - **선택한 시간 프레임 내에 생성 된 경고로 그룹 제한**: 비슷하거나 반복 되는 경고를 그룹화 할 시간 프레임을 결정 합니다. 이 시간 프레임 내에 해당 하는 모든 경고는 아래 그룹화 설정에 따라 인시던트 또는 인시던트 집합을 전체적으로 생성 합니다. 이 시간 프레임 이외의 경고는 별도의 인시던트 또는 인시던트 집합을 생성 합니다.

    - **이 분석 규칙에 의해 트리거되는 경고를 단일 인시던트**로 그룹화 합니다. 경고를 그룹화 할 기준을 선택 합니다.

        - **모든 엔터티가 일치 하는 경우 경고를 단일 인시던트에 그룹화**합니다. 위의 규칙 논리 설정 탭에 정의 된 매핑된 각 엔터티에 대해 동일한 값을 공유 하는 경우 경고를 그룹화 합니다. 권장 설정입니다.

        - **이 규칙에 의해 트리거되는 모든 경고를 단일 인시던트에 그룹화**합니다 .이 규칙에 의해 생성 된 모든 경고는 동일한 값을 공유 하지 않더라도 함께 그룹화 됩니다.

        - **선택한 엔터티가 일치 하는 경우 경고를 단일 인시던트에 그룹화**합니다. 매핑된 엔터티 중 일부에 대해 동일한 값을 공유 하는 경우 (드롭다운 목록에서 선택할 수 있음) 경고를 하나로 그룹화 합니다. 예를 들어 원본 또는 대상 IP 주소를 기반으로 별도의 인시던트를 만들려는 경우이 설정을 사용 하는 것이 좋습니다.

    - **닫힌 일치 인시던트 다시 열기**: 인시던트가 해결 되 고 종결 된 후 나중에 해당 인시던트에 속해야 하는 다른 경고가 생성 되 면이 설정을 **사용** 으로 설정 하 고, 종료 된 인시던트를 다시 열고, 경고를 통해 새 인시던트를 만들도록 설정 **된 상태를** 유지 합니다.
    
        > [!NOTE]
        > 최대 150 경고는 단일 인시던트로 그룹화 할 수 있습니다. 단일 인시던트로 그룹화 하는 규칙에 의해 150 개 이상의 경고가 생성 되 면 원래 인시던트와 동일한 인시던트 세부 정보를 사용 하 여 새 인시던트가 생성 되 고 초과 경고가 새 인시던트에 그룹화 됩니다.

1. 자동화 된 **응답** 탭에서 사용자 지정 규칙에 의해 경고가 생성 될 때 자동으로 실행 하려는 플레이 북를 선택 합니다. 플레이 북을 만들고 자동화 하는 방법에 대 한 자세한 내용은 [위협에 대응](tutorial-respond-threats-playbook.md)을 참조 하세요.

1. **검토 및 만들기** 를 선택 하 여 새 경고 규칙에 대 한 모든 설정을 검토 한 후 **만들기를 선택 하 여 경고 규칙을 초기화**합니다.
  
1. 경고가 생성 되 면 **활성 규칙**의 테이블에 사용자 지정 규칙이 추가 됩니다. 이 목록에서 각 규칙을 사용 하거나 사용 하지 않도록 설정 하거나 삭제할 수 있습니다.

1. 만든 경고 규칙의 결과를 보려면 **인시던트 페이지로 이동 하 여** 인시던트를 조사 하 고, [인시던트를 조사](tutorial-investigate-cases.md)하 고, 위협을 수정할 수 있습니다.


> [!NOTE]
> Azure 센티널에서 생성 된 경고는 [Microsoft Graph 보안](https://aka.ms/securitygraphdocs)을 통해 사용할 수 있습니다. 자세한 내용은 [Microsoft Graph 보안 경고 설명서](https://aka.ms/graphsecurityreferencebetadocs)를 참조 하세요.

## <a name="troubleshooting"></a>문제 해결

### <a name="a-scheduled-rule-failed-to-execute-or-appears-with-auto-disabled-added-to-the-name"></a>예약 된 규칙을 실행 하지 못했거나 이름에 자동 사용 안 함이 추가 된 상태로 표시 됩니다.

예약 된 쿼리 규칙이 실행 되지 않지만 발생할 수 있는 드문 경우입니다. Azure 센티널은 실패의 특정 유형과 그 원인이 되는 상황을 기반으로 하 여 일시적 또는 영구적으로 오류를 분류 합니다.

#### <a name="transient-failure"></a>일시적인 오류

일시적인 오류는 일시적인 상황으로 인해 발생 합니다 .이는 곧 정상적으로 돌아가서 규칙 실행이 성공 합니다. Azure 센티널에서 임시로 분류 하는 오류에 대 한 몇 가지 예는 다음과 같습니다.

- 규칙 쿼리를 실행 하는 데 시간이 너무 오래 걸리고 시간이 초과 되었습니다.
- 데이터 원본 및 Log Analytics 간의 연결 문제 또는 Log Analytics와 Azure 센티널 사이
- 다른 모든 신규 및 알 수 없는 오류는 일시적인 것으로 간주 됩니다.

일시적인 오류가 발생 하는 경우 Azure 센티널은 미리 결정 된 후 계속 해 서 규칙을 다시 실행 하려고 합니다. 그런 다음이 규칙은 다음에 예약 된 시간에만 다시 실행 됩니다. 일시적인 오류로 인해 규칙이 자동으로 사용 하지 않도록 설정 되지 않습니다.

#### <a name="permanent-failure---rule-auto-disabled"></a>영구 오류-규칙 자동 사용 안 함

규칙 실행을 허용 하는 조건의 변경으로 인해 영구적인 오류가 발생 하며,이는 사용자의 개입 없이 이전 상태로 돌아오지 않습니다. 영구 분류 된 오류의 몇 가지 예는 다음과 같습니다.

- 규칙 쿼리가 작동 하는 대상 작업 영역이 삭제 되었습니다.
- 규칙 쿼리가 작동 하는 대상 테이블은 삭제 되었습니다.
- Azure 센티널이 대상 작업 영역에서 제거 되었습니다.
- 규칙 쿼리에서 사용 되는 함수가 더 이상 유효 하지 않습니다. 수정 되었거나 제거 되었습니다.
- 규칙 쿼리의 데이터 원본 중 하나에 대 한 권한이 변경 되었습니다.
- 규칙 쿼리의 데이터 원본 중 하나가 삭제 되거나 연결 해제 되었습니다.

동일한 **유형 및 동일한 규칙의 연속 영구 오류 수를 미리 결정** 한 경우 Azure 센티널은 규칙의 실행을 중지 하 고 다음 단계를 수행 합니다.

- 규칙을 사용 하지 않도록 설정 합니다.
- 규칙 이름의 시작 부분에 **"자동 사용 안 함"** 이라는 단어를 추가 합니다.
- 오류의 원인 (및 비활성화)을 규칙의 설명에 추가 합니다.

규칙 목록을 이름별로 정렬 하 여 자동 사용 하지 않도록 설정 된 규칙이 있는지 쉽게 확인할 수 있습니다. 자동 사용 안 함 규칙은 목록의 맨 위 또는 맨 위에 표시 됩니다.

SOC 관리자는 자동 사용 하지 않도록 설정 된 규칙이 있는지 정기적으로 규칙 목록을 확인 해야 합니다.

## <a name="next-steps"></a>다음 단계

이 자습서에서는 Azure 센티널을 사용 하 여 위협 감지를 시작 하는 방법을 배웠습니다.

위협에 대 한 응답을 자동화 하는 방법을 알아보려면 [Azure 센티널에서 자동화 된 위협 응답을 설정](tutorial-respond-threats-playbook.md)합니다.

