---
title: Azure Cosmos DB를 사용한 전역 배포 - 기본적인 이해
description: 이 문서에서는 Azure Cosmos DB의 글로벌 배포와 관련된 기술 세부 정보를 제공합니다.
author: SnehaGunda
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 07/02/2020
ms.author: sngun
ms.reviewer: sngun
ms.openlocfilehash: 7e315a7366793d355967f777cbc1dda0f9277087
ms.sourcegitcommit: 845a55e6c391c79d2c1585ac1625ea7dc953ea89
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 07/05/2020
ms.locfileid: "85955916"
---
# <a name="global-data-distribution-with-azure-cosmos-db---under-the-hood"></a>Azure Cosmos DB를 사용한 전역 데이터 배포 - 기본적인 이해

Azure Cosmos DB는 Azure의 기본 서비스 이므로 공용, 소 버린, 보안 부서 (DoD) 및 정부 클라우드를 포함 하 여 전 세계 모든 Azure 지역에서 배포 됩니다. 데이터 센터 내에서 Azure Cosmos DB를 각각 전용 로컬 스토리지가 있는 대규모 스탬프의 머신에 배포 및 관리합니다. 데이터 센터 내에서 Azure Cosmos DB는 여러 클러스터로 배포되며 각각은 여러 세대의 하드웨어를 잠재적으로 실행할 수 있습니다. 클러스터 내의 컴퓨터는 일반적으로 지역 내에서 고가용성을 위해 10-20 장애 도메인에 분산 됩니다. 다음 이미지에서는 Cosmos DB 글로벌 배포 시스템 토폴로지를 보여 줍니다.

:::image type="content" source="./media/global-dist-under-the-hood/distributed-system-topology.png" alt-text="시스템 토폴로지" border="false":::

**Azure Cosmos DB의 글로벌 배포는 턴키입니다.** 언제 든 한 번의 클릭으로 또는 단일 API 호출을 사용 하 여 프로그래밍 방식으로 Cosmos 데이터베이스에 연결 된 지리적 지역을 추가 하거나 제거할 수 있습니다. Cosmos 데이터베이스는 일련의 Cosmos 컨테이너로 구성 됩니다. Cosmos DB에서 컨테이너는 배포 및 확장성의 논리 단위 역할을 합니다. 사용자가 만든 컬렉션, 테이블 및 그래프는 (내부적으로) Cosmos 컨테이너입니다. 컨테이너는 완전히 스키마를 제한 하지 않으며 쿼리 범위를 제공 합니다. Cosmos 컨테이너의 데이터는 수집 시 자동으로 인덱싱됩니다. 사용자는 자동 인덱싱을 사용 하 여 스키마 또는 인덱스 관리의 번거로운 업무 없이 데이터를 쿼리할 수 있습니다. 특히 전 세계적으로 분산 된 설정에서 데이터를 쿼리할 수 있습니다.  

- 지정 된 영역에서 컨테이너 내의 데이터는 사용자가 제공 하는 파티션 키를 사용 하 여 배포 되며 기본 실제 파티션에 의해 투명 하 게 관리 됩니다 (*로컬 배포*).  

- 각 실제 파티션은 지리적 지역에도 복제 됩니다 (*전역 배포*). 

Cosmos DB 탄력적으로를 사용 하는 앱이 Cosmos 컨테이너에서 처리량을 확장 하거나 더 많은 저장소를 사용 하는 경우 Cosmos DB는 모든 지역에서 파티션 관리 작업 (분할, 복제, 삭제)을 투명 하 게 처리 합니다. Cosmos DB는 확장, 배포 또는 장애와는 독립적으로 컨테이너 내에 있는 데이터의 단일 시스템 이미지를 지속적으로 제공하며, 이는 모든 지역에 걸쳐 전역적으로 배포됩니다.  

다음 그림에 표시 된 것 처럼 컨테이너 내의 데이터는 지역 내에서 전 세계 지역에 걸쳐 분산 됩니다.  

:::image type="content" source="./media/global-dist-under-the-hood/distribution-of-resource-partitions.png" alt-text="실제 파티션" border="false":::

실제 파티션은 *복제본 집합*이라는 복제본 그룹에 의해 구현 됩니다. 각 컴퓨터는 위의 이미지에 표시 된 것 처럼 고정 된 프로세스 집합 내에서 다양 한 실제 파티션에 해당 하는 수백 개의 복제본을 호스팅합니다. 실제 파티션에 해당하는 복제본은 클러스터 내의 머신과 지역 내의 데이터 센터 간에 동적으로 배치되고 부하가 분산됩니다.  

복제본은 고유하게 Azure Cosmos DB 테넌트에 속합니다. 각 복제본은 Cosmos DB [데이터베이스 엔진](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf)의 인스턴스를 호스트합니다. 이는 연결된 인덱스뿐만 아니라 리소스도 관리합니다. Cosmos 데이터베이스 엔진은 ARS (atom 레코드 시퀀스) 기반 형식 시스템에서 작동 합니다. 엔진은 스키마의 개념과 관계 없이 레코드의 구조 및 인스턴스 값 사이의 경계를 흐리게 합니다. Cosmos DB는 수집 시 모든 항목을 효율적인 방법으로 자동으로 인덱싱하여 사용자가 스키마나 인덱스 관리를 처리하지 않고도 전역적으로 분산된 데이터를 쿼리할 수 있도록 함으로써 완전한 스키마 불가지론성을 실현합니다.

Cosmos 데이터베이스 엔진은 각각 데이터의 트랜잭션 저장소 및 인덱싱을 담당 하는 여러 조정 기본 형식, 언어 런타임, 쿼리 프로세서 및 저장소 및 인덱싱 하위 시스템의 구현을 포함 하는 구성 요소로 구성 됩니다. 내구성과 고가용성을 제공하기 위해 데이터베이스 엔진은 해당 데이터 및 SSD에 대한 인덱스를 유지하고 복제본 집합 내에서 각각 데이터베이스 엔진 인스턴스 간에 복제합니다. 더 큰 테 넌 트는 처리량 및 저장소의 높은 규모에 해당 하 고 더 크거나 더 많은 복제본이 있거나 둘 다 있습니다. 시스템의 모든 구성 요소는 완전히 비동기식입니다. 즉, 스레드는 전혀 차단되지 않으며, 각 스레드는 불필요한 스레드 스위치를 발생시키지 않고 단시간 동안 작동합니다. 속도 제한 및 역 압력은 승인 제어에서 모든 I/O 경로까지 전체 스택에 걸쳐 연결됩니다. Cosmos 데이터베이스 엔진은 세분화 된 동시성을 활용 하 고 frugal 양의 시스템 리소스 내에서 작동 하는 동안 높은 처리량을 제공 하도록 설계 되었습니다.

Cosmos DB의 전역 배포는 *복제본 집합* 및 *파티션 집합*이라는 두 가지 주요 추상화를 사용 합니다. 복제본 세트는 조정을 위한 모듈식 레고 블록이며, 파티션 세트는 지리적으로 분산된 하나 이상의 실제 파티션에 대한 동적 오버레이입니다. 글로벌 배포의 작동 방식을 이해하려면 이러한 두 가지 주요 추상화를 이해해야 합니다. 

## <a name="replica-sets"></a>복제본 집합

실제 파티션은 자체 관리되고 여러 장애 도메인에 걸쳐 동적으로 부하가 분산된 복제본 그룹으로 구체화됩니다(복제본 세트라고 함). 이 세트는 복제된 상태 머신 프로토콜을 전체적으로 구현하여 실제 파티션 내 데이터를 고가용성, 내구성 및 일관성 있게 만듭니다. 복제본 집합 구성원 *N* 은 동적입니다. 오류, 관리 작업 및 실패 한 복제본이 다시 생성/복구 되는 시간에 따라 *Nmin* 과 *n 일별 최대* 사이에 변동을 유지 합니다. 멤버 자격 변경에 따라 복제본 프로토콜도 읽기 및 쓰기 쿼럼의 크기를 재구성합니다. 지정 된 실제 파티션에 할당 된 처리량을 균일 하 게 분산 하기 위해 다음 두 가지 개념을 사용 합니다. 

- 첫째, 리더에서 쓰기 요청을 처리 하는 비용이 종동체에 업데이트를 적용 하는 비용 보다 높습니다. 이에 따라, 리더는 팔로워에 비해 더 많은 시스템 리소스를 예산으로 충당합니다. 

- 둘째, 가급적 지정된 일관성 수준에 대한 읽기 쿼럼은 팔로워 복제본으로만 구성됩니다. 필요 없는 경우 읽기를 제공하기 위해 리더에게 연락하지 않습니다. Cosmos DB에서 지 원하는 [5 가지 일관성 모델](consistency-levels.md) 에 대 한 쿼럼 기반 시스템의 [부하와 용량과](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) 관련 하 여 수행 된 연구에서 많은 아이디어를 채택 하 고 있습니다.  

## <a name="partition-sets"></a>파티션 집합

Cosmos 데이터베이스 영역으로 구성 된 각각의 실제 파티션 그룹은 구성 된 모든 지역에서 복제 된 동일한 키 집합을 관리 하도록 구성 됩니다. 이 높은 조정 기본 형식을 *파티션 집합* 이라고 하며, 지정 된 키 집합을 관리 하는 실제 파티션의 지리적으로 분산 된 동적 오버레이입니다. 지정 된 물리적 파티션 (복제본 집합)은 클러스터 내에서 범위가 지정 되는 반면 파티션 집합은 클러스터, 데이터 센터 및 지리적 영역에 걸쳐 아래 이미지에 표시 된 것 처럼 확장 될 수 있습니다.  

:::image type="content" source="./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png" alt-text="파티션 세트" border="false":::

파티션 집합을 동일한 키 집합을 소유하는 여러 복제본 집합으로 구성된, 지리적으로 분산된 “슈퍼 복제본 집합”으로 생각할 수 있습니다. 복제본 집합과 마찬가지로, 파티션 집합의 멤버 자격은 동적입니다. 지정 된 파티션 집합에서 새 파티션을 추가/제거 하기 위한 암시적 물리적 파티션 관리 작업에 따라 변동 (예를 들어, 컨테이너에 대 한 처리량을 확장 하거나, Cosmos 데이터베이스에 영역을 추가/제거 하거나, 오류가 발생 한 경우)에 따라 변동 합니다. 파티션 집합의 각 파티션은 자체 복제본 집합 내에서 파티션 집합 멤버 자격을 관리 하기 때문에 멤버 자격은 완전히 분산 되 고 항상 사용 가능 합니다. 파티션 세트를 재구성하는 동안 실제 파티션 간 오버레이의 토폴로지도 설정됩니다. 토폴로지는 원본 및 대상 물리적 파티션 간의 일관성 수준, 지리적 거리 및 사용 가능한 네트워크 대역폭에 따라 동적으로 선택 됩니다.  

서비스를 사용하면 Cosmos 데이터베이스를 단일 쓰기 지역 또는 다중 쓰기 지역으로 구성할 수 있으며, 선택에 따라 파티션 집합은 단 하나의 지역 또는 모든 지역에서 쓰기를 허용하도록 구성됩니다. 시스템은 2단계의 중첩된 일치 프로토콜을 사용합니다. 한 레벨은 쓰기를 허용하는 실제 파티션의 복제본 세트의 복제본에서 작동하고, 다른 한 레벨은 파티션 세트 수준에서 작동하여 파티션 세트 내 모든 커밋된 쓰기에 대해 완벽한 순서를 보장합니다. 이 다층적이고 중첩된 일치는 고가용성을 위한 엄격한 SLA를 구현하고, 동시에 Cosmos DB가 고객에게 제공하는 일관성 모델을 구현하는 데 매우 중요합니다.  

## <a name="conflict-resolution"></a>충돌 해결

업데이트 전파, 충돌 해결 및 인과 관계 추적을 위한 설계는 [유행병 알고리즘](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) 및 [Bayou](https://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf) 시스템에 대한 이전 작업에서 영감을 받았습니다. 아이디어의 핵심은 살아남아 Cosmos DB의 시스템 설계를 전달하는 데 편리한 참조 프레임을 제공하는 한편, Cosmos DB 시스템에 적용되면서 상당한 변화를 겪기도 했습니다. 이전 시스템은 리소스 관리 나 Cosmos DB 해야 하는 규모를 비롯 하 여, 기능 (예: 제한 된 부실 일관성) 및 Cosmos DB 고객에 게 제공 되는 엄격한 Sla 및 포괄적인 Sla를 제공 하지 않도록 설계 되었기 때문에이 작업이 필요 했습니다.  

파티션 세트는 여러 지역에 분산되어 있으며 Cosmos DB(다중 마스터) 복제 프로토콜에 따라 지정된 파티션 세트로 구성된 실제 파티션 간에 데이터를 복제합니다. 파티션 세트의 각 실제 파티션은 쓰기를 허용하며 일반적으로 해당 지역에 있는 클라이언트에 읽기를 제공합니다. 지역 내의 실제 파티션에서 수락된 쓰기는 지속력 있게 커밋되며 클라이언트에서 승인되기 전에 해당 실제 파티션 내에서 높은 가용성을 제공합니다. 이러한 쓰기는 임시 쓰기이며, 엔트로피 방지 채널을 사용하여 파티션 세트 내의 다른 실제 파티션으로 전파됩니다. 클라이언트는 요청 헤더를 전달하여 임시 쓰기나 커밋된 쓰기를 요청할 수 있습니다. 엔트로피 방지 전파(전파 빈도 포함)는 파티션 세트의 토폴로지, 실제 파티션의 지역적 근접성 및 구성된 일관성 수준에 따라 동적입니다. 파티션 집합 내에서 Cosmos DB는 동적으로 선택된 중재자 파티션과 함께 기본 커밋 체계를 따릅니다. 중재자 선택은 동적이며 오버레이의 토폴로지에 따라 파티션 집합을 재구성하는 데 필수적인 부분입니다. 커밋된 쓰기(다중 행/일괄 처리 업데이트 포함)는 순서가 보장됩니다. 

인과 관계 추적 및 버전 벡터를 위한 인코딩된 벡터 클록(복제본 집합과 파티션 집합 각각에서 각 일치 수준에 해당하는 지역 ID 및 논리적 클록 포함)을 사용하여 업데이트 충돌을 탐지하고 해결합니다. 토폴로지 및 피어 선택 알고리즘은 버전 벡터의 고정적이며 최소한의 스토리지와 최소한의 네트워크 오버헤드를 보장하도록 설계되었습니다. 알고리즘은 엄격한 수렴 속성을 보장합니다.  

여러 쓰기 지역으로 구성된 Cosmos 데이터베이스의 경우, 시스템은 다음을 포함하여 개발자가 선택할 수 있는 유연하며 다양한 자동 충돌 해결 정책을 제공합니다. 

- 기본적으로 시간 동기화 클록 프로토콜을 기반으로 하는 시스템 정의 타임 스탬프 속성을 사용 하는 **마지막-쓰기-Wins (LWW)** 또한 Cosmos DB를 사용하면 충돌 해결에 사용할 다른 사용자 지정 숫자 속성을 지정할 수 있습니다.  
- 응용 프로그램 **정의 (사용자 지정) 충돌 해결 정책** (병합 프로시저를 통해 표시)-응용 프로그램에서 정의 된 충돌의 의미 체계 조정을 위해 설계 되었습니다. 이러한 프로시저는 서버 쪽의 데이터베이스 트랜잭션에서 쓰기-쓰기 충돌이 검색될 때 호출됩니다. 시스템은 커밋 프로토콜의 일부로 병합 프로시저의 실행을 정확히 한 번 보장 합니다. 사용할 수 있는 [몇 가지 충돌 해결 샘플이](how-to-manage-conflicts.md) 있습니다.  

## <a name="consistency-models"></a>일관성 모델

단일 또는 여러 쓰기 지역으로 Cosmos 데이터베이스를 구성 하는 경우에는 잘 정의 된 5 가지 일관성 모델에서 선택할 수 있습니다. 여러 쓰기 지역이 있는 경우 일관성 수준에 대 한 몇 가지 주목할 만한 부분은 다음과 같습니다.  

제한 된 부실 일관성은 모든 지역에서 모든 읽기의 최근 쓰기에서 *K* 접두사 또는 *T* 초 내에 모든 읽기를 보장 합니다. 또한 제한 된 부실 일관성을 가진 읽기는 단조 이며 일관 된 접두사 보장이 보장 됩니다. 엔트로피 방지 프로토콜은 속도 제한 방식으로 작동하며, 접두사가 누적되지 않고 쓰기에서 역 압력을 적용할 필요가 없음을 보장합니다. 세션 일관성은 단조 읽기, 단조 쓰기, 고유한 쓰기 읽기, 쓰기 후 읽기 및 일관 된 접두사 보증을 전 세계적으로 보장 합니다. 강력한 일관성을 사용 하 여 구성 된 데이터베이스의 경우 여러 하위 지역에 대 한 동기 복제로 인해 여러 쓰기 영역의 이점 (낮은 쓰기 대기 시간, 높은 쓰기 가능)이 적용 되지 않습니다.

Cosmos DB에서 5 가지 일관성 모델의 의미 체계 [는 여기에 설명 되어](consistency-levels.md)있으며, [여기](https://github.com/Azure/azure-cosmos-tla)에서 개략적인 TLA + 사양을 사용 하 여 수학적으로 설명 되어 있습니다.

## <a name="next-steps"></a>다음 단계

이제 다음 문서를 사용하여 글로벌 배포를 구성하는 방법을 알아봅니다.

* [데이터베이스 계정에서 Azure 지역 추가/제거](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [클라이언트에서 멀티 호밍(multi-homing)을 구성하는 방법](how-to-manage-database-account.md#configure-multiple-write-regions)
* [사용자 지정 충돌 해결 정책을 만드는 방법](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy)
